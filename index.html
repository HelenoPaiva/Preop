<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Preoperative Evaluation / Avaliação Pré-operatória</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Theme Variables */
    :root{
      --bg-deep: #020617; /* slate-950 */
      --glass-bg: rgba(15, 23, 42, 0.70); /* slate-900 with opacity */
      --glass-border: rgba(148, 163, 184, 0.15); /* slate-400 low opacity */
      --glass-soft: rgba(30, 41, 59, 0.5); /* slate-800 low opacity */
      --primary: #3b82f6; /* blue-500 */
      --success: #22c55e; /* green-500 */
      --text-main: #f1f5f9; /* slate-100 */
      --text-muted: #94a3b8; /* slate-400 */
    }

    /* Background Fix */
    body {
      background-color: var(--bg-deep);
      background-image: 
        radial-gradient(circle at 50% 0%, rgba(59, 130, 246, 0.15), transparent 60%),
        linear-gradient(to bottom, #0f172a 0%, var(--bg-deep) 100%);
      background-attachment: fixed;
      color: var(--text-main);
      min-height: 100vh;
      font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    /* Form Fields */
    .field {
      background: rgba(2, 6, 23, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: 0.5rem;
      color: white;
      transition: all 0.2s;
    }
    .field:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    select.field {
      appearance: none;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
      background-position: right 0.5rem center;
      background-repeat: no-repeat;
      background-size: 1.5em 1.5em;
      padding-right: 2.5rem;
    }

    /* Cards (Glass Effect) */
    .glass {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* Softer inner containers */
    .glass-soft {
      background: var(--glass-soft);
      border: 1px solid rgba(148, 163, 184, 0.1);
      border-radius: 0.75rem;
    }

    /* Metric Box (BMI, IBW) */
    .metric-box {
      background: rgba(30, 41, 59, 0.4);
      border: 1px solid rgba(148, 163, 184, 0.15);
      border-radius: 0.75rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    /* Buttons */
    .btn {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.3);
      border-radius: 0.5rem;
      transition: all 0.2s;
      font-weight: 500;
    }
    .btn:hover {
      background: rgba(51, 65, 85, 0.9);
      border-color: rgba(148, 163, 184, 0.5);
    }
    .btn-primary {
      background: rgba(34, 197, 94, 0.15);
      border-color: rgba(34, 197, 94, 0.4);
      color: #86efac;
    }
    .btn-primary:hover {
      background: rgba(34, 197, 94, 0.25);
      border-color: rgba(34, 197, 94, 0.6);
    }
    .btn-toggle-active {
      background-color: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    .btn-toggle-inactive {
      color: var(--text-muted);
    }
    .btn-toggle-inactive:hover {
      color: var(--text-main);
    }

    /* Range Sliders */
    input[type="range"] {
      width: 100%;
      height: 6px;
      background: #334155;
      border-radius: 3px;
      outline: none;
      appearance: none;
    }
    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      border: 2px solid var(--bg-deep);
    }
    
    /* Layout Utilities */
    .topbar {
      border-bottom: 1px solid var(--glass-border);
      background: rgba(2, 6, 23, 0.8);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 50;
    }
    .bottombar {
      position: sticky;
      bottom: 0;
      z-index: 50;
      border-top: 1px solid var(--glass-border);
      background: rgba(2, 6, 23, 0.9);
      backdrop-filter: blur(12px);
    }
    
    /* Improved Checkbox Row Style (STOP-BANG Style) */
    .check-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s;
      cursor: pointer;
    }
    .check-row:hover {
      background-color: rgba(30, 41, 59, 0.5);
    }
    .check-row.disabled {
      background-color: rgba(30, 41, 59, 0.3);
      opacity: 0.8;
      cursor: default;
    }
    input[type="checkbox"] {
      margin-top: 0.1rem;
      height: 1rem;
      width: 1rem;
      border-radius: 0.25rem;
      border-color: #64748b;
      background-color: #0f172a;
    }
    input[type="checkbox"]:checked {
      background-color: var(--primary);
      border-color: var(--primary);
    }
  </style>
</head>

<body>

  <div class="topbar">
    <div class="max-w-6xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between gap-4">
        <div class="min-w-0 flex flex-col justify-center">
          <div class="text-base sm:text-lg font-bold leading-tight tracking-tight text-white" data-i18n="app_title">
            Preoperative Evaluation
          </div>
          <div class="text-xs text-slate-400 mt-0.5" data-i18n="app_subtitle">
            Ferramenta local para estruturar avaliação perioperatória.
          </div>
        </div>

        <div class="flex items-center gap-3 shrink-0">
          
          <div class="flex items-center bg-slate-800/80 rounded-lg p-1 border border-slate-700/50">
            <button id="lang-pt-btn" class="px-3 py-1 rounded-md text-[11px] font-semibold transition-colors btn-toggle-active" aria-label="Português">PT</button>
            <button id="lang-en-btn" class="px-3 py-1 rounded-md text-[11px] font-semibold transition-colors btn-toggle-inactive" aria-label="English">EN</button>
          </div>

          <a href="https://github.com/HelenoPaiva/Preop"
             target="_blank"
             class="hidden sm:inline-block text-xs text-blue-400 hover:text-blue-300 hover:underline decoration-dotted transition-colors"
             data-i18n="github_link">
            GitHub
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-3 sm:px-4 py-6">
    <div id="validation-banner" class="hidden mb-6 rounded-xl border border-rose-800/40 bg-rose-950/20 px-4 py-3 text-sm backdrop-blur-sm">
      <div class="flex items-center gap-2 font-semibold text-rose-200">
        <svg class="w-4 h-4 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
        <span data-i18n="validation_title">Revise os itens abaixo:</span>
      </div>
      <ul id="validation-list" class="mt-2 list-disc pl-6 text-rose-100/80 space-y-1 text-xs"></ul>
    </div>

    <main class="grid gap-6 lg:grid-cols-[1.2fr_1fr] items-start">
      
      <section class="space-y-6">
        
        <div class="glass p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white" data-i18n="section_patient_title">Dados Gerais</h2>
            <div class="h-2 w-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></div>
          </div>

          <div class="grid gap-4 sm:grid-cols-2">
            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="age_label">Idade</span>
              <input id="age" type="number" min="16" max="100" class="field px-3 py-2 text-sm" placeholder="52" data-i18n-placeholder="age_ph" />
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="sex_label">Sexo</span>
              <select id="sex" class="field px-3 py-2 text-sm">
                <option value="" data-i18n="select">Selecionar…</option>
                <option value="male" data-i18n="male">Masculino</option>
                <option value="female" data-i18n="female">Feminino</option>
              </select>
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="height_label">Altura (cm)</span>
              <input id="height" type="number" min="120" max="220" class="field px-3 py-2 text-sm" placeholder="170" data-i18n-placeholder="height_ph" />
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="weight_label">Peso (kg)</span>
              <input id="weight" type="number" min="30" max="300" class="field px-3 py-2 text-sm" placeholder="120" data-i18n-placeholder="weight_ph" />
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="asa_label">ASA</span>
              <select id="asa" class="field px-3 py-2 text-sm">
                <option value="" data-i18n="select">Selecionar…</option>
                <option value="I">ASA I</option>
                <option value="II">ASA II</option>
                <option value="III">ASA III</option>
                <option value="IV">ASA IV</option>
                <option value="V">ASA V</option>
              </select>
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="anesthesia_label">Anestesia</span>
              <select id="anesthesia-type" class="field px-3 py-2 text-sm">
                <option value="" data-i18n="select">Selecionar…</option>
                <option value="general" data-i18n="an_general">Anestesia Geral</option>
                <option value="neuraxial" data-i18n="an_neuraxial">Anestesia de Neuroeixo</option>
                <option value="block" data-i18n="an_block">Bloqueio de Nervo</option>
                <option value="sedation" data-i18n="an_sedation">Sedação</option>
              </select>
            </label>

            <label class="flex flex-col sm:col-span-2">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="procedure_label">Procedimento</span>
              <input id="procedure" class="field px-3 py-2 text-sm" placeholder="Ex: Colecistectomia VLP" data-i18n-placeholder="procedure_ph" />
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="duration_label">Duração (h)</span>
              <input id="surgery-duration" type="number" step="0.5" min="0" max="12" class="field px-3 py-2 text-sm" placeholder="2" data-i18n-placeholder="duration_ph" />
            </label>

            <div class="flex items-center h-full pt-6">
              <label class="inline-flex items-center gap-3 cursor-pointer group">
                <input id="emergency-surgery" type="checkbox" class="peer sr-only" />
                <div class="h-5 w-5 rounded border border-slate-500 bg-slate-800 peer-checked:bg-rose-600 peer-checked:border-rose-500 transition-colors flex items-center justify-center">
                   <svg class="w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <span class="text-sm text-slate-300 group-hover:text-white transition-colors" data-i18n="emergency_label">Urgência / Emergência</span>
              </label>
            </div>
          </div>

          <div class="mt-6 grid gap-3 sm:grid-cols-3">
            <div class="metric-box px-4 py-3">
              <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1" data-i18n="bmi_chip">IMC</div>
              <div class="flex items-baseline gap-2">
                 <div id="bmi-display" class="text-xl font-bold text-white">—</div>
                 <div class="text-xs text-slate-500">kg/m²</div>
              </div>
              <div id="bmi-category" class="text-[11px] text-slate-400 mt-1 truncate" data-i18n="bmi_hint">Informe altura e peso</div>
            </div>

            <div class="metric-box px-4 py-3">
              <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1" data-i18n="ibw_chip">Peso Ideal</div>
              <div class="flex items-baseline gap-2">
                 <div id="ibw-display" class="text-xl font-bold text-white">—</div>
                 <div class="text-xs text-slate-500">kg</div>
              </div>
              <div id="ibw-hint" class="text-[11px] text-slate-400 mt-1 truncate" data-i18n="ibw_hint">Requer sexo + altura</div>
            </div>

            <div class="metric-box px-4 py-3">
              <div class="text-[10px] text-slate-400 uppercase tracking-wider mb-1" data-i18n="context_chip">Contexto</div>
              <div id="context-display" class="text-sm font-bold text-white leading-tight mt-0.5">—</div>
              <div class="text-[11px] text-slate-400 mt-1 leading-tight" data-i18n="context_hint">Influencia ARISCAT</div>
            </div>
          </div>
        </div>

        <div class="glass p-5">
          <h2 class="text-lg font-semibold text-white mb-4" data-i18n="section_airway_title">Avaliação da Via Aérea</h2>

          <div class="grid gap-4 sm:grid-cols-2">
            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="mallampati_label">Mallampati</span>
              <select id="mallampati" class="field px-3 py-2 text-sm">
                <option value="" data-i18n="select">Selecionar…</option>
                <option value="1">I</option>
                <option value="2">II</option>
                <option value="3">III</option>
                <option value="4">IV</option>
              </select>
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="mouth_opening_label">Abertura bucal (cm)</span>
              <input id="mouth-opening" type="number" step="0.1" min="0" max="10" class="field px-3 py-2 text-sm" placeholder="4.5" data-i18n-placeholder="mouth_opening_ph" />
            </label>

            <label class="flex flex-col">
              <span class="mb-1.5 text-xs font-medium text-slate-300" data-i18n="tmd_label">Dist. Tireomentoniana (cm)</span>
              <input id="tmd" type="number" step="0.1" min="0" max="15" class="field px-3 py-2 text-sm" placeholder="7.0" data-i18n-placeholder="tmd_ph" />
            </label>

            <div class="flex items-center h-full pt-6">
              <label class="inline-flex items-center gap-3 cursor-pointer group">
                <input id="jaw-limited" type="checkbox" class="peer sr-only" />
                <div class="h-5 w-5 rounded border border-slate-500 bg-slate-800 peer-checked:bg-blue-600 peer-checked:border-blue-500 transition-colors flex items-center justify-center">
                   <svg class="w-3.5 h-3.5 text-white opacity-0 peer-checked:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                </div>
                <span class="text-sm text-slate-300 group-hover:text-white transition-colors" data-i18n="jaw_limited_label">Protrusão mandibular limitada</span>
              </label>
            </div>

            <div class="sm:col-span-2 glass-soft p-4 mt-1">
              <div class="flex items-center justify-between gap-3 mb-2">
                <div class="text-sm text-slate-200 font-medium" data-i18n="neck_mobility_title">Mobilidade cervical</div>
                <div class="text-xs px-2 py-0.5 rounded bg-slate-800 border border-slate-700">
                  <span data-i18n="points_label">Pontos:</span> <span id="neck-mobility-points" class="font-bold text-blue-400">0</span>
                </div>
              </div>
              <input id="neck-mobility" type="range" min="0" max="2" step="1" class="w-full accent-blue-500 cursor-pointer" />
              <div class="mt-2 text-xs text-slate-400 text-center">
                <span id="neck-mobility-label">—</span>
              </div>
            </div>

            <div class="sm:col-span-2 glass-soft p-4">
              <div class="flex items-center justify-between gap-3 mb-2">
                <div class="text-sm text-slate-200 font-medium" data-i18n="diff_history_title">História de intubação difícil</div>
                <div class="text-xs px-2 py-0.5 rounded bg-slate-800 border border-slate-700">
                  <span data-i18n="points_label">Pontos:</span> <span id="diff-history-points" class="font-bold text-blue-400">0</span>
                </div>
              </div>
              <input id="diff-history" type="range" min="0" max="2" step="1" class="w-full accent-blue-500 cursor-pointer" />
              <div class="mt-2 text-xs text-slate-400 text-center">
                <span id="diff-history-label">—</span>
              </div>
            </div>
          </div>

          <div class="mt-4 pt-4 border-t border-slate-700/50">
            <div class="flex items-center justify-between">
              <div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-wider" data-i18n="egri_chip">El-Ganzouri (EGRI)</span>
                <div class="text-2xl font-bold text-white mt-1"><span id="egri-score">0</span> <span class="text-sm font-normal text-slate-500">pts</span></div>
              </div>
              <div class="text-right">
                <div id="egri-badge" class="badge-ok text-xs font-bold px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20">—</div>
                <div id="egri-category" class="text-xs text-slate-400 mt-1">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass p-5">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-white" data-i18n="section_stopbang_title">STOP-BANG</h2>
            <div class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
              <span class="text-xl font-bold text-white" id="sb-score">0</span><span class="text-xs text-slate-500">/8</span>
            </div>
          </div>

          <div class="grid gap-3 sm:grid-cols-2 text-sm text-slate-300">
            <label class="check-row">
              <input type="checkbox" id="sb-snoring" />
              <span data-i18n="sb_snoring">Ronco alto</span>
            </label>
            <label class="check-row">
              <input type="checkbox" id="sb-tired" />
              <span data-i18n="sb_tired">Fadiga diurna</span>
            </label>
            <label class="check-row">
              <input type="checkbox" id="sb-observed" />
              <span data-i18n="sb_observed">Apneia observada</span>
            </label>
            <label class="check-row">
              <input type="checkbox" id="sb-pressure" />
              <span data-i18n="sb_pressure">Hipertensão</span>
            </label>
            
            <label class="check-row disabled">
              <input type="checkbox" id="sb-bmi" disabled />
              <span data-i18n="sb_bmi">IMC > 35 (auto)</span>
            </label>
            <label class="check-row disabled">
              <input type="checkbox" id="sb-age" disabled />
              <span data-i18n="sb_age">Idade > 50 (auto)</span>
            </label>
            <label class="check-row">
              <input type="checkbox" id="sb-neck" />
              <span data-i18n="sb_neck">Pescoço > 40cm</span>
            </label>
            <label class="check-row disabled">
              <input type="checkbox" id="sb-gender" disabled />
              <span data-i18n="sb_gender">Sexo masc. (auto)</span>
            </label>
          </div>
          
          <div class="mt-3 text-xs text-right text-slate-400">
            <span data-i18n="category_label">Risco:</span> <span id="sb-category" class="font-bold text-white uppercase">—</span>
          </div>
        </div>

        <div class="glass p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-semibold text-white" data-i18n="rcri_title">RCRI</h2>
              <div class="text-[10px] text-slate-400">Risco Cardíaco</div>
            </div>
            <div class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
              <span class="text-xl font-bold text-white" id="rcri-score">0</span><span class="text-xs text-slate-500">/6</span>
            </div>
          </div>
          
          <div class="grid gap-3 sm:grid-cols-2 text-sm text-slate-300">
             <label class="check-row"><input type="checkbox" id="rcri-highrisk"> <span data-i18n="rcri_highrisk">Cirurgia alto risco</span></label>
             <label class="check-row"><input type="checkbox" id="rcri-ihd"> <span data-i18n="rcri_ihd">Doença isquêmica</span></label>
             <label class="check-row"><input type="checkbox" id="rcri-chf"> <span data-i18n="rcri_chf">Insuf. Cardíaca</span></label>
             <label class="check-row"><input type="checkbox" id="rcri-cva"> <span data-i18n="rcri_cva">D. Cerebrovascular</span></label>
             <label class="check-row"><input type="checkbox" id="rcri-insulin"> <span data-i18n="rcri_insulin">Insulinodependente</span></label>
             <label class="check-row"><input type="checkbox" id="rcri-creatinine"> <span data-i18n="rcri_creat">Cr > 2.0</span></label>
          </div>
          <div class="mt-3 text-xs text-slate-400 border-t border-slate-700/50 pt-2 flex justify-between">
             <span><span data-i18n="category_label">Risco:</span> <span id="rcri-category" class="text-white font-medium">—</span></span>
             <span class="text-blue-400"><span data-i18n="risk_label">Risco:</span> <span id="rcri-risk-percent">—</span></span>
          </div>
        </div>

        <div class="glass p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-semibold text-white" data-i18n="ariscat_title">ARISCAT</h2>
              <div class="text-[10px] text-slate-400">Complicação Pulmonar</div>
            </div>
            <div class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
              <span class="text-xl font-bold text-white" id="ariscat-score">0</span> <span class="text-xs text-slate-500">pts</span>
            </div>
          </div>
          
          <div class="grid gap-4 sm:grid-cols-2">
             <label class="block">
               <span class="text-[10px] text-slate-400 uppercase font-bold" data-i18n="spo2_label">SpO2 Pré-op</span>
               <input id="ariscat-spo2" type="number" class="field w-full px-2 py-1.5 text-xs mt-1" placeholder="98" />
             </label>
             <label class="block">
               <span class="text-[10px] text-slate-400 uppercase font-bold" data-i18n="incision_label">Incisão</span>
               <select id="ariscat-incision" class="field w-full px-2 py-1.5 text-xs mt-1">
                  <option value="" data-i18n="select">...</option>
                  <option value="peripheral" data-i18n="inc_peripheral">Periférica</option>
                  <option value="upper-abdominal" data-i18n="inc_upper">Abd. Superior</option>
                  <option value="intrathoracic" data-i18n="inc_thoracic">Intratorácica</option>
               </select>
             </label>
          </div>
          <div class="mt-4 grid gap-3 sm:grid-cols-2 text-sm text-slate-300">
             <label class="check-row"><input type="checkbox" id="ariscat-infection"> <span data-i18n="ariscat_infection">Infecção resp. recente</span></label>
             <label class="check-row"><input type="checkbox" id="ariscat-anemia"> <span data-i18n="ariscat_anemia">Hb ≤ 10 g/dL</span></label>
          </div>
          <div class="mt-3 text-xs text-slate-400 border-t border-slate-700/50 pt-2 flex justify-between">
             <span><span data-i18n="category_label">Risco:</span> <span id="ariscat-category" class="text-white font-medium">—</span></span>
             <span class="text-blue-400"><span data-i18n="risk_label">Risco:</span> <span id="ariscat-risk">—</span></span>
          </div>
        </div>

        <div class="glass p-5">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h2 class="text-lg font-semibold text-white" data-i18n="apfel_title2">Apfel</h2>
              <div class="text-[10px] text-slate-400">Náusea/Vômito (NVPO)</div>
            </div>
            <div class="bg-slate-800 px-3 py-1 rounded-lg border border-slate-700">
              <span class="text-xl font-bold text-white" id="apfel-score">0</span><span class="text-xs text-slate-500">/4</span>
            </div>
          </div>
          
          <div class="grid gap-3 sm:grid-cols-2 text-sm text-slate-300">
            <label class="check-row"><input type="checkbox" id="apfel-nonsmoker"> <span data-i18n="apfel_nonsmoker">Não tabagista</span></label>
            <label class="check-row"><input type="checkbox" id="apfel-history"> <span data-i18n="apfel_history">História de NVPO</span></label>
            <label class="check-row"><input type="checkbox" id="apfel-opioids"> <span data-i18n="apfel_opioids">Opioide pós-op</span></label>
            
            <label class="check-row disabled">
               <input type="checkbox" id="apfel-female" disabled> 
               <span data-i18n="apfel_female">Sexo feminino (auto)</span>
            </label>
          </div>
          <div class="mt-3 text-xs text-slate-400 border-t border-slate-700/50 pt-2 flex justify-between">
             <span><span data-i18n="category_label">Risco:</span> <span id="apfel-category" class="text-white font-medium">—</span></span>
             <span class="text-blue-400"><span data-i18n="risk_label">Risco:</span> <span id="apfel-risk">—</span></span>
          </div>
        </div>

      </section>

      <section>
        <div class="glass p-5 sticky top-24">
          <div class="flex items-center justify-between gap-3 mb-4">
            <h2 class="text-lg font-semibold text-white" data-i18n="output_title">Texto Gerado</h2>
            <button id="copy-output-btn" class="btn btn-primary text-xs px-3 py-1.5 flex items-center gap-1.5 shadow-lg shadow-emerald-900/20">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
              <span data-i18n="copy">Copiar</span>
            </button>
          </div>

          <p class="text-[11px] text-slate-400 mb-3" data-i18n="output_hint">
            O texto abaixo é atualizado automaticamente conforme você preenche os dados.
          </p>

          <textarea id="output" readonly
                    class="w-full h-[600px] sm:h-[calc(100vh-250px)] rounded-xl border border-slate-800 bg-[#0B101E] px-4 py-4 text-sm font-mono leading-relaxed text-slate-300 focus:outline-none focus:ring-1 focus:ring-blue-500/50 resize-y shadow-inner"
                    spellcheck="false"></textarea>

          <div class="mt-4 text-[10px] leading-snug text-slate-500 text-center px-4" data-i18n="disclaimer">
            Esta ferramenta não substitui julgamento clínico. Verifique todos os escores antes de utilizar.
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="bottombar sm:hidden">
    <div class="px-4 py-3 flex items-center justify-between">
      <div class="text-xs text-slate-400" data-i18n="footer_hint">Pronto para prontuário</div>
      <button id="copy-output-btn-bottom" class="btn btn-primary text-xs px-4 py-2 font-bold">
        <span data-i18n="copy_summary">COPIAR</span>
      </button>
    </div>
  </div>

  <script>
    /* -------------------------------------------------------------------------
       CORE LOGIC
       ------------------------------------------------------------------------- */
    
    // I18N Data
    const I18N = {
      en: {
        app_title: "Preoperative Evaluation",
        app_subtitle: "Local tool for perioperative risk assessment.",
        github_link: "GitHub",
        validation_title: "Please review:",
        select: "Select…",
        male: "Male",
        female: "Female",

        section_patient_title: "General Data",
        age_label: "Age",
        age_ph: "52",
        sex_label: "Sex",
        height_label: "Height (cm)",
        height_ph: "170",
        weight_label: "Weight (kg)",
        weight_ph: "120",
        asa_label: "ASA Class",
        anesthesia_label: "Anesthesia",
        an_general: "General anesthesia",
        an_neuraxial: "Neuraxial anesthesia",
        an_block: "Nerve block",
        an_sedation: "Sedation",
        procedure_label: "Procedure",
        procedure_ph: "e.g., Lap Chole",
        duration_label: "Duration (h)",
        duration_ph: "2",
        emergency_label: "Emergency Surgery",

        bmi_chip: "BMI",
        bmi_hint: "Needs height/weight",
        ibw_chip: "IBW (Devine)",
        ibw_hint: "Needs sex + height",
        context_chip: "Context",
        context_hint: "Affects ARISCAT",

        section_airway_title: "Airway Assessment",
        mallampati_label: "Mallampati",
        mouth_opening_label: "Mouth Open (cm)",
        mouth_opening_ph: "4.5",
        tmd_label: "Thyromental (cm)",
        tmd_ph: "7.0",
        jaw_limited_label: "Limited Mandibular Protrusion",
        neck_mobility_title: "Neck Mobility",
        diff_history_title: "History of Difficult Intubation",
        points_label: "Points:",
        egri_chip: "El-Ganzouri (EGRI)",
        category_label: "Category:",
        risk_label: "Risk:",
        score_label: "Score:",

        section_stopbang_title: "STOP-BANG",
        sb_snoring: "Loud Snoring",
        sb_tired: "Tired/Fatigued",
        sb_observed: "Observed Apnea",
        sb_pressure: "Hypertension",
        sb_bmi: "BMI > 35 (auto)",
        sb_age: "Age > 50 (auto)",
        sb_neck: "Neck > 40cm",
        sb_gender: "Male sex (auto)",
        
        rcri_title: "RCRI",
        rcri_highrisk: "High-risk surgery",
        rcri_ihd: "Ischemic heart dis.",
        rcri_chf: "Heart failure",
        rcri_cva: "Cerebrovascular dis.",
        rcri_insulin: "Insulin diabetic",
        rcri_creat: "Creatinine > 2.0",

        ariscat_title: "ARISCAT",
        spo2_label: "Pre-op SpO₂",
        ariscat_infection: "Recent resp. infection",
        ariscat_anemia: "Hb ≤ 10 g/dL",
        incision_label: "Incision Site",
        inc_peripheral: "Peripheral",
        inc_upper: "Upper Abd.",
        inc_thoracic: "Intrathoracic",

        apfel_title2: "Apfel",
        apfel_nonsmoker: "Non-smoker",
        apfel_history: "Hx PONV/Motion sick",
        apfel_opioids: "Post-op Opioids",
        apfel_female: "Female sex (auto)",
        apfel_sex_auto: "Female sex (auto)",

        output_title: "Generated Text",
        output_hint: "Text updates automatically as you type.",
        copy: "Copy",
        disclaimer: "Tool does not replace clinical judgment. Verify all scores.",
        footer_hint: "Ready to paste",
        copy_summary: "COPY",

        // Output Text
        neck0: "Normal",
        neck1: "Mild limit",
        neck2: "Severe limit",
        hist0: "None",
        hist1: "Possible",
        hist2: "Definite",

        elective: "Elective surgery.",
        emergency: "Emergency surgery.",
        asa_unspecified: "ASA not specified.",
        duration_unspecified: "Duration not specified.",
        anesthesia_unspecified: "anesthesia TBD",
        scheduled_for: "scheduled for",
        under: "under",

        patient_intro_male: "This is a {age}-year-old male patient {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_female: "This is a {age}-year-old female patient {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_neutral: "Patient {scheduled_for} {procedure} {under} {anesthesia}.",

        bmi_line: "BMI {bmi} kg/m² ({bmiClass}).",
        bmi_missing: "BMI not available.",
        ibw_line: "IBW {ibw} kg.",
        ibw_missing: "IBW not available.",
        asa_line: "ASA {asa}.",
        duration_line: "Est. duration: {dur} h.",

        sb_line: "STOP-BANG: {score}/8 ({cat}).",
        rcri_line: "RCRI: {score}/6 ({cat}) — risk {risk}.",
        ariscat_line: "ARISCAT: {score} ({cat}) — risk {risk}.",
        apfel_line: "Apfel: {score}/4 ({cat}) — risk ~{risk}.",
        egri_line: "El-Ganzouri: {score} ({cat}).",

        vent_line: "If GA: consider lung-protective ventilation, TV ≈ {vt} mL (≈ 6-8 mL/kg IBW).",

        extras_title: "Considerations:",
        ponv_extra: "High PONV risk: multimodal prophylaxis indicated.",
        osa_extra: "High OSA risk: consider enhanced resp monitoring.",
        egri_extra: "High Difficult Airway risk: plan advanced airway strategy.",
        obesity_extra: "Severe obesity: airway and atelectasis risks.",

        // Categories
        rcri0: "Low", rcri1: "Low", rcri2: "Elevated", rcri3: "High",
        sb_low: "Low", sb_int: "Intermediate", sb_high: "High",
        egri_low: "Low risk", egri_high: "High risk",
        ar_low: "Low", ar_int: "Intermed", ar_high: "High",
        apfel_low: "Low", apfel_int: "Intermed", apfel_high: "High",
        badge_low: "Low", badge_high: "High"
      },

      pt: {
        app_title: "Avaliação Pré-operatória",
        app_subtitle: "Ferramenta local para estruturar avaliação perioperatória.",
        github_link: "GitHub",
        validation_title: "Revise os itens abaixo:",
        select: "Selecionar…",
        male: "Masculino",
        female: "Feminino",

        section_patient_title: "Dados Gerais",
        age_label: "Idade",
        age_ph: "52",
        sex_label: "Sexo",
        height_label: "Altura (cm)",
        height_ph: "170",
        weight_label: "Peso (kg)",
        weight_ph: "120",
        asa_label: "ASA",
        anesthesia_label: "Anestesia",
        an_general: "Anestesia Geral",
        an_neuraxial: "Anestesia de Neuroeixo",
        an_block: "Bloqueio de Nervo",
        an_sedation: "Sedação",
        procedure_label: "Procedimento",
        procedure_ph: "Ex: Colecistectomia VLP",
        duration_label: "Duração (h)",
        duration_ph: "2",
        emergency_label: "Urgência / Emergência",

        bmi_chip: "IMC",
        bmi_hint: "Informe altura e peso",
        ibw_chip: "Peso Ideal (Devine)",
        ibw_hint: "Requer sexo + altura",
        context_chip: "Contexto",
        context_hint: "Influencia ARISCAT",

        section_airway_title: "Avaliação da Via Aérea",
        mallampati_label: "Mallampati",
        mouth_opening_label: "Abertura Bucal (cm)",
        mouth_opening_ph: "4,5",
        tmd_label: "Dist. Tireomentoniana (cm)",
        tmd_ph: "7,0",
        jaw_limited_label: "Protrusão mandibular limitada",
        neck_mobility_title: "Mobilidade Cervical",
        diff_history_title: "História de Intubação Difícil",
        points_label: "Pontos:",
        egri_chip: "El-Ganzouri (EGRI)",
        category_label: "Categoria:",
        risk_label: "Risco:",
        score_label: "Escore:",

        section_stopbang_title: "STOP-BANG",
        sb_snoring: "Ronco alto",
        sb_tired: "Fadiga diurna",
        sb_observed: "Apneia observada",
        sb_pressure: "Hipertensão",
        sb_bmi: "IMC > 35 (auto)",
        sb_age: "Idade > 50 (auto)",
        sb_neck: "Pescoço > 40cm",
        sb_gender: "Sexo masc. (auto)",

        rcri_title: "RCRI",
        rcri_highrisk: "Cirurgia alto risco",
        rcri_ihd: "Doença isquêmica",
        rcri_chf: "Insuf. Cardíaca",
        rcri_cva: "D. Cerebrovascular",
        rcri_insulin: "Insulinodependente",
        rcri_creat: "Cr > 2.0",

        ariscat_title: "ARISCAT",
        spo2_label: "SpO₂ Pré-op",
        ariscat_infection: "Infecção resp. recente",
        ariscat_anemia: "Hb ≤ 10 g/dL",
        incision_label: "Incisão",
        inc_peripheral: "Periférica",
        inc_upper: "Abd. Superior",
        inc_thoracic: "Intratorácica",

        apfel_title2: "Apfel",
        apfel_nonsmoker: "Não tabagista",
        apfel_history: "História de NVPO",
        apfel_opioids: "Opioide pós-op",
        apfel_female: "Sexo feminino (auto)",
        apfel_sex_auto: "Sexo fem. auto",

        output_title: "Texto Gerado",
        output_hint: "O texto abaixo é atualizado automaticamente conforme você preenche os dados.",
        copy: "Copiar",
        disclaimer: "Esta ferramenta não substitui julgamento clínico. Verifique todos os escores antes de utilizar.",
        footer_hint: "Pronto para prontuário",
        copy_summary: "COPIAR",

        // Output Text
        neck0: "Normal",
        neck1: "Limitação leve",
        neck2: "Limitação grave",
        hist0: "Não",
        hist1: "Duvidosa",
        hist2: "Definitiva",

        elective: "Cirurgia eletiva.",
        emergency: "Cirurgia de urgência/emergência.",
        asa_unspecified: "Estado físico ASA não informado.",
        duration_unspecified: "Duração estimada não informada.",
        anesthesia_unspecified: "técnica anestésica a definir",
        scheduled_for: "agendado(a) para",
        under: "sob",

        patient_intro_male: "Paciente masculino de {age} anos {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_female: "Paciente feminino de {age} anos {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_neutral: "Paciente {scheduled_for} {procedure} {under} {anesthesia}.",

        bmi_line: "IMC {bmi} kg/m² ({bmiClass}).",
        bmi_missing: "IMC indisponível.",
        ibw_line: "Peso ideal (Devine) {ibw} kg.",
        ibw_missing: "Peso ideal indisponível.",
        asa_line: "Estado físico ASA {asa}.",
        duration_line: "Duração estimada: {dur} h.",

        sb_line: "STOP-BANG: {score}/8 ({cat}).",
        rcri_line: "RCRI: {score}/6 ({cat}) — risco {risk}.",
        ariscat_line: "ARISCAT: {score} ({cat}) — risco {risk}.",
        apfel_line: "Apfel: {score}/4 ({cat}) — risco est. ~{risk}.",
        egri_line: "El-Ganzouri: {score} ({cat}).",

        vent_line: "Se anestesia geral: considerar ventilação protetora com volume corrente ≈ {vt} mL (≈ 7 mL/kg peso ideal).",

        extras_title: "Pontos adicionais:",
        ponv_extra: "Risco elevado de NVPO: considerar profilaxia multimodal.",
        osa_extra: "STOP-BANG alto: considerar monitorização resp. intensificada.",
        egri_extra: "EGRI alto: planejar estratégia avançada de via aérea.",
        obesity_extra: "Obesidade grave: riscos aumentados de VA e atelectasia.",

        // Categories
        rcri0: "Baixo", rcri1: "Baixo", rcri2: "Elevado", rcri3: "Alto",
        sb_low: "Baixo", sb_int: "Intermediário", sb_high: "Alto",
        egri_low: "Baixo risco", egri_high: "Alto risco",
        ar_low: "Baixo", ar_int: "Intermediário", ar_high: "Alto",
        apfel_low: "Baixo", apfel_int: "Intermediário", apfel_high: "Alto",
        badge_low: "Baixo", badge_high: "Alto"
      }
    };

    // State
    const state = { lang: "pt" };

    function t(key) {
      return (I18N[state.lang] && I18N[state.lang][key]) ?? I18N.en[key] ?? key;
    }

    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = t(key);
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        el.setAttribute("placeholder", t(key));
      });
      document.querySelectorAll("option[data-i18n]").forEach(opt => {
        const key = opt.getAttribute("data-i18n");
        opt.textContent = t(key);
      });
    }

    // Helpers
    function toNumber(value) {
      const n = parseFloat(String(value).replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function fmt1(n) { return (Math.round(n * 10) / 10).toFixed(1); }
    function clamp(num, min, max) { return Math.min(Math.max(num, min), max); }
    function template(str, vars) {
      return str.replace(/\{(\w+)\}/g, (_, k) => (vars[k] ?? ""));
    }
    function roundToNearest5(x) { return Math.round(x / 5) * 5; }

    function classifyBMI(bmi) {
      if (bmi == null) return { label: "—" };
      if (bmi < 18.5) return { label: state.lang === "pt" ? "Baixo peso" : "Underweight" };
      if (bmi < 25) return { label: state.lang === "pt" ? "Normal" : "Normal" };
      if (bmi < 30) return { label: state.lang === "pt" ? "Sobrepeso" : "Overweight" };
      if (bmi < 35) return { label: state.lang === "pt" ? "Obesidade I" : "Obesity I" };
      if (bmi < 40) return { label: state.lang === "pt" ? "Obesidade II" : "Obesity II" };
      return { label: state.lang === "pt" ? "Obesidade III" : "Obesity III" };
    }

    function classifyStopBang(score) {
      if (score <= 2) return t("sb_low");
      if (score <= 4) return t("sb_int");
      return t("sb_high");
    }

    // RCRI Category logic
    function classifyRCRI(score) {
      if (score === 0) return t("rcri0");
      if (score === 1) return t("rcri1");
      if (score === 2) return t("rcri2");
      return t("rcri3");
    }

    // RCRI Risk % logic
    function getRCRIRisk(score) {
      if (score === 0) return "0.5%";
      if (score === 1) return "1.1%";
      if (score === 2) return "5%";
      return "10%"; // >= 3
    }

    function devineIBW(sex, heightCm) {
      if (!sex || heightCm == null) return null;
      const inches = heightCm / 2.54;
      const base = sex === "male" ? 50 : 45.5;
      const ibw = base + 2.3 * (inches - 60);
      return Math.round(ibw * 10) / 10;
    }

    // Apfel logic
    function computeApfel({ sex, nonsmoker, historyPONV, opioids }) {
      let score = 0;
      if (sex === "female") score += 1;
      if (nonsmoker) score += 1;
      if (historyPONV) score += 1;
      if (opioids) score += 1;
      
      const mapRisk = { 0: "10%", 1: "21%", 2: "39%", 3: "61%", 4: "79%" };
      const risk = mapRisk[clamp(score, 0, 4)];
      
      let categoryKey;
      if (score <= 1) categoryKey = "apfel_low";
      else if (score === 2) categoryKey = "apfel_int";
      else categoryKey = "apfel_high"; // 3 or 4

      return { score, risk, category: t(categoryKey) };
    }

    // ARISCAT Computation
    function computeARISCAT(age, spo2, infection, anemia, incision, durationHours, emergency) {
      let score = 0;
      if (age != null) {
        if (age >= 51 && age <= 80) score += 3;
        else if (age >= 81) score += 16;
      }
      if (spo2 != null) {
        if (spo2 >= 96) score += 0;
        else if (spo2 >= 91 && spo2 <= 95) score += 8;
        else score += 24;
      }
      if (infection) score += 17;
      if (anemia) score += 11;
      if (incision === "upper-abdominal") score += 15;
      else if (incision === "intrathoracic") score += 24;
      if (durationHours != null) {
        if (durationHours < 2) score += 0;
        else if (durationHours <= 3) score += 16;
        else score += 23;
      }
      if (emergency) score += 8;

      let categoryKey, riskText;
      if (score < 26) { categoryKey = "ar_low"; riskText = "1.6%"; } 
      else if (score <= 44) { categoryKey = "ar_int"; riskText = "13.3%"; } 
      else { categoryKey = "ar_high"; riskText = "42.1%"; }

      return { score, category: t(categoryKey), risk: riskText };
    }

    // EGRI Computation
    function computeEGRI({ mallampati, mouthOpening, tmd, jawLimited, weightKg, neckMobilityPoints, diffHistoryPoints }) {
      let score = 0;
      if (mallampati === 2) score += 1;
      if (mallampati === 3 || mallampati === 4) score += 2;
      if (mouthOpening != null) {
        if (mouthOpening < 3.5) score += 2;
        else if (mouthOpening < 4.0) score += 1;
      }
      if (tmd != null) {
        if (tmd < 6) score += 2;
        else if (tmd < 6.5) score += 1;
      }
      if (jawLimited) score += 1;
      if (weightKg != null) {
        if (weightKg >= 90 && weightKg <= 110) score += 1;
        else if (weightKg > 110) score += 2;
      }
      score += neckMobilityPoints || 0;
      score += diffHistoryPoints || 0;

      const high = score >= 4;
      const category = high ? t("egri_high") : t("egri_low");
      const badgeText = high ? t("badge_high") : t("badge_low");
      const badgeClass = high ? "badge-bad" : "badge-ok";

      return { score, category, badgeText, badgeClass };
    }

    function computeSTOPBANG({ snoring, tired, observed, pressure, bmi, age, neckLarge, sex }) {
      let score = 0;
      if (snoring) score += 1;
      if (tired) score += 1;
      if (observed) score += 1;
      if (pressure) score += 1;
      
      const bmiHigh = bmi != null && bmi >= 35;
      if (bmiHigh) score += 1;
      
      const ageHigh = age != null && age > 50;
      if (ageHigh) score += 1;
      
      if (neckLarge) score += 1;
      
      const male = sex === "male";
      if (male) score += 1;

      const category = classifyStopBang(score);
      return { score, category, bmiHigh, ageHigh, male };
    }

    function computeRCRI({ highRiskSurgery, ischemicHeartDisease, chf, cva, insulin, creatinineHigh }) {
      let score = 0;
      if (highRiskSurgery) score += 1;
      if (ischemicHeartDisease) score += 1;
      if (chf) score += 1;
      if (cva) score += 1;
      if (insulin) score += 1;
      if (creatinineHigh) score += 1;
      
      const category = classifyRCRI(score);
      const risk = getRCRIRisk(score);
      return { score, category, risk };
    }

    // Main Update Loop
    function updateDerivedMetrics() {
      const age = toNumber(document.getElementById("age").value);
      const sex = document.getElementById("sex").value;
      const height = toNumber(document.getElementById("height").value);
      const weight = toNumber(document.getElementById("weight").value);
      const emergency = document.getElementById("emergency-surgery").checked;

      let bmiValue = null;
      if (height != null && weight != null && height > 0) {
        const hMeters = height / 100;
        bmiValue = weight / (hMeters * hMeters);
      }

      const bmiDisplay = document.getElementById("bmi-display");
      const bmiCategory = document.getElementById("bmi-category");
      if (bmiValue != null) {
        const cls = classifyBMI(bmiValue);
        bmiDisplay.textContent = fmt1(bmiValue);
        bmiCategory.textContent = cls.label;
      } else {
        bmiDisplay.textContent = "—";
        bmiCategory.textContent = t("bmi_hint");
      }

      const ibw = devineIBW(sex, height);
      const ibwDisplay = document.getElementById("ibw-display");
      const ibwHint = document.getElementById("ibw-hint");
      if (ibw != null) {
        ibwDisplay.textContent = fmt1(ibw);
        ibwHint.textContent = ""; 
      } else {
        ibwDisplay.textContent = "—";
        ibwHint.textContent = t("ibw_hint");
      }

      const contextDisplay = document.getElementById("context-display");
      if (emergency) {
        contextDisplay.textContent = state.lang === 'pt' ? "Emergência" : "Emergency";
        contextDisplay.className = "text-sm font-bold text-rose-400 leading-tight mt-0.5";
      } else {
        contextDisplay.textContent = state.lang === 'pt' ? "Eletiva" : "Elective";
        contextDisplay.className = "text-sm font-bold text-emerald-400 leading-tight mt-0.5";
      }

      // STOP-BANG auto flags
      const sbBmi = document.getElementById("sb-bmi");
      const sbAge = document.getElementById("sb-age");
      const sbGender = document.getElementById("sb-gender");

      const bmiHigh = bmiValue != null && bmiValue >= 35;
      const ageHigh = age != null && age > 50;
      const male = sex === "male";

      sbBmi.checked = bmiHigh;
      sbAge.checked = ageHigh;
      sbGender.checked = male;
      
      // Apfel auto flag
      const apfelFemale = document.getElementById("apfel-female");
      if (apfelFemale) {
        apfelFemale.checked = (sex === "female");
      }

      return { bmiValue, ibw };
    }

    function updateScoresAndOutput() {
      const { bmiValue, ibw } = updateDerivedMetrics();

      const age = toNumber(document.getElementById("age").value);
      const sex = document.getElementById("sex").value;
      const height = toNumber(document.getElementById("height").value);
      const weight = toNumber(document.getElementById("weight").value);
      const asa = document.getElementById("asa").value;
      const anesthesiaType = document.getElementById("anesthesia-type").value;
      const procedure = document.getElementById("procedure").value.trim();
      const duration = toNumber(document.getElementById("surgery-duration").value);
      const emergency = document.getElementById("emergency-surgery").checked;

      // Airway inputs
      const mallampatiVal = toNumber(document.getElementById("mallampati").value);
      const mouthOpening = toNumber(document.getElementById("mouth-opening").value);
      const tmd = toNumber(document.getElementById("tmd").value);
      const jawLimited = document.getElementById("jaw-limited").checked;
      const neckMobilityPoints = toNumber(document.getElementById("neck-mobility").value) || 0;
      const diffHistoryPoints = toNumber(document.getElementById("diff-history").value) || 0;

      // STOP-BANG manual
      const sbSnoring = document.getElementById("sb-snoring").checked;
      const sbTired = document.getElementById("sb-tired").checked;
      const sbObserved = document.getElementById("sb-observed").checked;
      const sbPressure = document.getElementById("sb-pressure").checked;
      const sbNeck = document.getElementById("sb-neck").checked;

      // RCRI
      const rcriHighRisk = document.getElementById("rcri-highrisk").checked;
      const rcriIHD = document.getElementById("rcri-ihd").checked;
      const rcriCHF = document.getElementById("rcri-chf").checked;
      const rcriCVA = document.getElementById("rcri-cva").checked;
      const rcriInsulin = document.getElementById("rcri-insulin").checked;
      const rcriCreat = document.getElementById("rcri-creatinine").checked;

      // ARISCAT
      const arSpO2 = toNumber(document.getElementById("ariscat-spo2").value);
      const arInfection = document.getElementById("ariscat-infection").checked;
      const arAnemia = document.getElementById("ariscat-anemia").checked;
      const arIncision = document.getElementById("ariscat-incision").value;

      // Apfel
      const apfelNonsmoker = document.getElementById("apfel-nonsmoker").checked;
      const apfelHistory = document.getElementById("apfel-history").checked;
      const apfelOpioids = document.getElementById("apfel-opioids").checked;

      // Calculations
      const sbResult = computeSTOPBANG({
        snoring: sbSnoring, tired: sbTired, observed: sbObserved, pressure: sbPressure,
        bmi: bmiValue, age, neckLarge: sbNeck, sex
      });
      document.getElementById("sb-score").textContent = sbResult.score;
      document.getElementById("sb-category").textContent = sbResult.category;

      const rcri = computeRCRI({
        highRiskSurgery: rcriHighRisk, ischemicHeartDisease: rcriIHD, chf: rcriCHF,
        cva: rcriCVA, insulin: rcriInsulin, creatinineHigh: rcriCreat
      });
      document.getElementById("rcri-score").textContent = rcri.score;
      document.getElementById("rcri-category").textContent = rcri.category;
      document.getElementById("rcri-risk-percent").textContent = rcri.risk;

      const ariscat = computeARISCAT(age, arSpO2, arInfection, arAnemia, arIncision, duration, emergency);
      document.getElementById("ariscat-score").textContent = ariscat.score;
      document.getElementById("ariscat-category").textContent = ariscat.category;
      document.getElementById("ariscat-risk").textContent = ariscat.risk;

      const apfel = computeApfel({ sex, nonsmoker: apfelNonsmoker, historyPONV: apfelHistory, opioids: apfelOpioids });
      document.getElementById("apfel-score").textContent = apfel.score;
      document.getElementById("apfel-category").textContent = apfel.category;
      document.getElementById("apfel-risk").textContent = apfel.risk;

      const egriResult = computeEGRI({
        mallampati: mallampatiVal, mouthOpening, tmd, jawLimited, weightKg: weight,
        neckMobilityPoints, diffHistoryPoints
      });
      document.getElementById("egri-score").textContent = egriResult.score;
      document.getElementById("egri-category").textContent = egriResult.category;
      
      // Update badge style
      const egriBadge = document.getElementById("egri-badge");
      egriBadge.textContent = egriResult.badgeText;
      if (egriResult.badgeClass === "badge-bad") {
        egriBadge.className = "text-xs font-bold px-3 py-1 rounded-full bg-rose-500/10 text-rose-400 border border-rose-500/20";
      } else {
        egriBadge.className = "text-xs font-bold px-3 py-1 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
      }

      // Slider labels
      const neckLabel = document.getElementById("neck-mobility-label");
      if (neckMobilityPoints === 0) neckLabel.textContent = t("neck0");
      else if (neckMobilityPoints === 1) neckLabel.textContent = t("neck1");
      else neckLabel.textContent = t("neck2");
      document.getElementById("neck-mobility-points").textContent = neckMobilityPoints;

      const diffLabel = document.getElementById("diff-history-label");
      if (diffHistoryPoints === 0) diffLabel.textContent = t("hist0");
      else if (diffHistoryPoints === 1) diffLabel.textContent = t("hist1");
      else diffLabel.textContent = t("hist2");
      document.getElementById("diff-history-points").textContent = diffHistoryPoints;

      buildOutput({ age, sex, height, weight, asa, anesthesiaType, procedure, duration, emergency, bmi: bmiValue, ibw, sbResult, rcri, ariscat, apfel, egriResult });
    }

    function buildOutput(ctx) {
      const { age, sex, asa, anesthesiaType, procedure, duration, emergency, bmi, ibw, sbResult, rcri, ariscat, apfel, egriResult } = ctx;
      const lines = [];

      const anesthesiaText = anesthesiaType
        ? document.querySelector(`#anesthesia-type option[value="${anesthesiaType}"]`)?.textContent
        : t("anesthesia_unspecified");

      const procText = procedure || (state.lang === "pt" ? "cirurgia eletiva" : "elective surgery");
      let introTemplate;
      if (sex === "male") introTemplate = t("patient_intro_male");
      else if (sex === "female") introTemplate = t("patient_intro_female");
      else introTemplate = t("patient_intro_neutral");

      lines.push(template(introTemplate, {
        age: age != null ? age : "",
        scheduled_for: t("scheduled_for"),
        procedure: procText,
        under: t("under"),
        anesthesia: anesthesiaText
      }).trim());

      lines.push(emergency ? t("emergency") : t("elective"));
      
      if (asa) lines.push(template(t("asa_line"), { asa }));
      else lines.push(t("asa_unspecified"));
      
      if (duration != null) lines.push(template(t("duration_line"), { dur: fmt1(duration) }));

      if (bmi != null) {
        const cls = classifyBMI(bmi);
        lines.push(template(t("bmi_line"), { bmi: fmt1(bmi), bmiClass: cls.label }));
      } else lines.push(t("bmi_missing"));

      if (ibw != null) lines.push(template(t("ibw_line"), { ibw: fmt1(ibw) }));

      lines.push("");
      lines.push(template(t("sb_line"), { score: sbResult.score, cat: sbResult.category }));
      lines.push(template(t("rcri_line"), { score: rcri.score, cat: rcri.category, risk: rcri.risk }));
      lines.push(template(t("ariscat_line"), { score: ariscat.score, cat: ariscat.category, risk: ariscat.risk }));
      lines.push(template(t("apfel_line"), { score: apfel.score, cat: apfel.category, risk: apfel.risk }));
      lines.push(template(t("egri_line"), { score: egriResult.score, cat: egriResult.category }));

      if (anesthesiaType === "general" && ibw != null) {
        const vtRaw = ibw * 7;
        const vt = roundToNearest5(vtRaw);
        lines.push(template(t("vent_line"), { vt }));
      }

      const extras = [];
      if (apfel.score >= 3) extras.push(t("ponv_extra"));
      if (sbResult.score >= 5) extras.push(t("osa_extra"));
      if (egriResult.score >= 4) extras.push(t("egri_extra"));
      if (bmi != null && bmi >= 40) extras.push(t("obesity_extra"));

      if (extras.length > 0) {
        lines.push("");
        lines.push(t("extras_title"));
        extras.forEach(e => lines.push("• " + e));
      }

      document.getElementById("output").value = lines.join("\n");
    }

    // Validation
    function validateInputs() {
      const issues = [];
      const age = toNumber(document.getElementById("age").value);
      const height = toNumber(document.getElementById("height").value);
      const weight = toNumber(document.getElementById("weight").value);

      if (age == null || age < 16 || age > 100) {
        issues.push(state.lang === "pt" ? "Idade (16–100)" : "Age (16–100)");
      }
      if (height == null || height < 120 || height > 220) {
        issues.push(state.lang === "pt" ? "Altura (120–220)" : "Height (120–220)");
      }
      if (weight == null || weight < 30 || weight > 300) {
        issues.push(state.lang === "pt" ? "Peso (30–300)" : "Weight (30–300)");
      }

      const banner = document.getElementById("validation-banner");
      const list = document.getElementById("validation-list");
      if (!banner || !list) return;

      if (issues.length > 0) {
        banner.classList.remove("hidden");
        list.innerHTML = "";
        issues.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = msg;
          list.appendChild(li);
        });
      } else {
        banner.classList.add("hidden");
      }
    }

    // Copy setup
    function setupCopyButtons() {
      function doCopy() {
        const text = document.getElementById("output").value;
        if (!text) return;
        navigator.clipboard.writeText(text).catch(() => {});
      }
      document.getElementById("copy-output-btn")?.addEventListener("click", doCopy);
      document.getElementById("copy-output-btn-bottom")?.addEventListener("click", doCopy);
    }

    // Lang Toggle
    function setupLanguageToggle() {
      const ptBtn = document.getElementById("lang-pt-btn");
      const enBtn = document.getElementById("lang-en-btn");

      function updateButtons() {
        if (state.lang === "pt") {
          ptBtn.classList.add("btn-toggle-active");
          ptBtn.classList.remove("btn-toggle-inactive");
          enBtn.classList.add("btn-toggle-inactive");
          enBtn.classList.remove("btn-toggle-active");
        } else {
          enBtn.classList.add("btn-toggle-active");
          enBtn.classList.remove("btn-toggle-inactive");
          ptBtn.classList.add("btn-toggle-inactive");
          ptBtn.classList.remove("btn-toggle-active");
        }
      }

      ptBtn.addEventListener("click", () => {
        state.lang = "pt";
        applyI18n();
        updateDerivedMetrics();
        updateScoresAndOutput();
        updateButtons();
      });

      enBtn.addEventListener("click", () => {
        state.lang = "en";
        applyI18n();
        updateDerivedMetrics();
        updateScoresAndOutput();
        updateButtons();
      });

      updateButtons();
    }

    // Init
    document.addEventListener("DOMContentLoaded", () => {
      applyI18n();
      setupLanguageToggle();
      setupCopyButtons();
      
      const inputs = [
        "age","sex","height","weight","asa","anesthesia-type","procedure",
        "surgery-duration","emergency-surgery",
        "mallampati","mouth-opening","tmd","jaw-limited","neck-mobility","diff-history",
        "sb-snoring","sb-tired","sb-observed","sb-pressure","sb-neck",
        "rcri-highrisk","rcri-ihd","rcri-chf","rcri-cva","rcri-insulin","rcri-creatinine",
        "ariscat-spo2","ariscat-infection","ariscat-anemia","ariscat-incision",
        "apfel-nonsmoker","apfel-history","apfel-opioids"
      ];
      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = el.tagName === "SELECT" || el.type === "checkbox" || el.type === "range" ? "change" : "input";
        el.addEventListener(evt, () => {
          updateScoresAndOutput();
          validateInputs();
        });
        if (el.tagName === "INPUT" && el.type !== "checkbox" && el.type !== "range") {
           el.addEventListener("blur", validateInputs);
        }
      });

      updateScoresAndOutput();
      validateInputs();
    });
  </script>
</body>
</html>
