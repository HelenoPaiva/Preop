<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Preoperative Evaluation / Avaliação Pré-operatória</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* App baseline (match BariCalc / Gastric Volume Estimator vibe) */
    :root{
      --bg0:#050814;
      --bg1:#070b1c;
      --card:rgba(14,18,38,.72);
      --card2:rgba(14,18,38,.55);
      --stroke:rgba(148,163,184,.18);
      --stroke2:rgba(148,163,184,.12);
      --text:#e5e7eb;
      --muted:rgba(226,232,240,.75);
      --muted2:rgba(226,232,240,.55);
      --accent:#22c55e; /* green */
      --accent2:#3b82f6; /* blue */
      --shadow: 0 20px 60px rgba(0,0,0,.45);
    }
    html, body { height: 100%; }
    body{
      background:
        radial-gradient(900px 900px at 30% -10%, rgba(59,130,246,.20), transparent 55%),
        radial-gradient(900px 900px at 80% 10%, rgba(34,197,94,.12), transparent 60%),
        radial-gradient(1200px 900px at 50% 110%, rgba(2,6,23,.9), rgba(2,6,23,1) 45%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      color: var(--text);
    }
    /* Avoid iOS zoom on inputs */
    input, select, textarea { font-size: 16px; }
    /* Range */
    input[type="range"] { width: 100%; }
    /* Subtle glass */
    .glass{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      border-radius: 1.25rem;
    }
    .glass-soft{
      background: var(--card2);
      border: 1px solid var(--stroke2);
      backdrop-filter: blur(8px);
      border-radius: 1.25rem;
    }
    .field{
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.22);
      border-radius: 0.75rem;
    }
    .field:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(59,130,246,.25);
      border-color: rgba(59,130,246,.45);
    }
    .chip{
      background: rgba(2,6,23,.55);
      border-radius: 9999px;
      border: 1px solid rgba(148,163,184,.18);
    }
    .divider{
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(148,163,184,.18), transparent);
    }
    .topbar{
      border-bottom: 1px solid rgba(148,163,184,.14);
      background: linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.55));
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 40;
    }
    .bottombar{
      position: sticky;
      bottom: 0;
      z-index: 40;
      border-top: 1px solid rgba(148,163,184,.14);
      background: linear-gradient(180deg, rgba(2,6,23,.20), rgba(2,6,23,.90));
      backdrop-filter: blur(10px);
    }
    .btn{
      background: rgba(2,6,23,.55);
      border-radius: 9999px;
      border: 1px solid rgba(148,163,184,.22);
      padding: 0.4rem 0.9rem;
    }
    .btn:hover{ border-color: rgba(148,163,184,.35); }
    .btn:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(59,130,246,.25);
      border-color: rgba(59,130,246,.45);
    }
    .btn-primary{
      background: rgba(34,197,94,.12);
      border-color: rgba(34,197,94,.30);
    }
    .btn-primary:hover{ border-color: rgba(34,197,94,.45); }
    .badge-ok{
      background: rgba(34,197,94,.14);
      border-radius: 9999px;
      border: 1px solid rgba(34,197,94,.28);
      color: rgba(187,247,208,.95);
    }
    .badge-warn{
      background: rgba(245,158,11,.12);
      border-radius: 9999px;
      border: 1px solid rgba(245,158,11,.26);
      color: rgba(254,243,199,.95);
    }
    .badge-bad{
      background: rgba(244,63,94,.12);
      border-radius: 9999px;
      border: 1px solid rgba(244,63,94,.28);
      color: rgba(255,228,230,.95);
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="topbar">
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3 sm:py-4">
      <div class="flex items-center justify-between gap-3">
        <div class="min-w-0">
          <div class="text-base sm:text-lg font-semibold leading-tight text-white" data-i18n="app_title">
            Preoperative Evaluation
          </div>
          <div class="text-[11px] sm:text-xs text-slate-300/80 mt-0.5 max-w-2xl" data-i18n="app_subtitle">
            Ferramenta local (no navegador) para estruturar avaliação perioperatória e gerar um resumo pronto para copiar. Nenhum dado é enviado para servidor.
          </div>
        </div>

        <div class="flex items-center gap-2 shrink-0">
          <div class="inline-flex items-center gap-2 rounded-full chip px-2 py-1 text-[11px]">
            <span class="text-slate-300 select-none">EN-PT</span>
            <div class="inline-flex items-center rounded-full bg-slate-900/60 border border-slate-700 p-0.5">
              <button id="lang-pt-btn" class="px-2 py-1 rounded-full bg-blue-500 text-white font-medium" aria-label="Português">PT</button>
              <button id="lang-en-btn" class="px-2 py-1 rounded-full text-slate-200" aria-label="English">EN</button>
            </div>
          </div>

          <a href="https://github.com/HelenoPaiva/Preop"
             target="_blank"
             class="text-[11px] sm:text-xs text-blue-400 hover:text-blue-300 underline decoration-dotted">
            <span data-i18n="github_link">Ver no GitHub</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
    <div id="validation-banner" class="hidden mb-4 rounded-2xl border border-rose-700/40 bg-rose-950/30 px-4 py-3 text-sm">
      <div class="font-semibold text-rose-200" data-i18n="validation_title">Revise os itens abaixo:</div>
      <ul id="validation-list" class="mt-2 list-disc pl-5 text-rose-100/90 space-y-1"></ul>
    </div>

    <main class="grid gap-4 sm:gap-6 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)]">
      <section class="space-y-4">
        <div class="glass">
          <div class="px-4 sm:px-5 py-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-xs text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="section_patient_kicker">Paciente</div>
                <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_patient_title">Dados do Paciente e Cirurgia</h2>
              </div>
              <div class="hidden sm:flex items-center gap-2">
                <div class="text-[11px] text-slate-300/70" data-i18n="local_only">Local</div>
                <div class="h-1.5 w-1.5 rounded-full bg-emerald-400/80"></div>
              </div>
            </div>

            <div class="mt-3 grid gap-3 sm:grid-cols-2">
              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="age_label">Idade (anos)</span>
                <input id="age" type="number" min="16" max="100"
                       class="field px-3 py-2 text-sm"
                       placeholder="52" data-i18n-placeholder="age_ph" />
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="sex_label">Sexo ao nascimento</span>
                <select id="sex" class="field px-3 py-2 text-sm">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="male" data-i18n="male">Masculino</option>
                  <option value="female" data-i18n="female">Feminino</option>
                </select>
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="height_label">Altura (cm)</span>
                <input id="height" type="number" min="120" max="220"
                       class="field px-3 py-2 text-sm"
                       placeholder="170" data-i18n-placeholder="height_ph" />
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="weight_label">Peso (kg)</span>
                <input id="weight" type="number" min="30" max="300"
                       class="field px-3 py-2 text-sm"
                       placeholder="120" data-i18n-placeholder="weight_ph" />
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="asa_label">Classificação ASA</span>
                <select id="asa" class="field px-3 py-2 text-sm">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="I">ASA I</option>
                  <option value="II">ASA II</option>
                  <option value="III">ASA III</option>
                  <option value="IV">ASA IV</option>
                  <option value="V">ASA V</option>
                </select>
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="anesthesia_label">Anestesia planejada</span>
                <select id="anesthesia-type" class="field px-3 py-2 text-sm">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="general" data-i18n="an_general">Anestesia geral</option>
                  <option value="neuraxial" data-i18n="an_neuraxial">Anestesia neuroaxial</option>
                  <option value="block" data-i18n="an_block">Bloqueio de Nervo</option>
                  <option value="sedation" data-i18n="an_sedation">Sedação / cuidado monitorizado</option>
                </select>
              </label>

              <label class="flex flex-col sm:col-span-2">
                <span class="mb-1 text-xs text-slate-200" data-i18n="procedure_label">Procedimento planejado (texto livre)</span>
                <input id="procedure" class="field px-3 py-2 text-sm"
                       placeholder="Bypass gástrico laparoscópico" data-i18n-placeholder="procedure_ph" />
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="duration_label">Duração estimada (horas)</span>
                <input id="surgery-duration" type="number" step="0.5" min="0" max="12"
                       class="field px-3 py-2 text-sm"
                       placeholder="3" data-i18n-placeholder="duration_ph" />
              </label>

              <label class="inline-flex items-center gap-2 mt-1 sm:mt-6">
                <input id="emergency-surgery" type="checkbox"
                       class="h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span class="text-sm text-slate-200" data-i18n="emergency_label">Cirurgia de urgência/emergência</span>
              </label>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-3 text-xs">
              <div class="chip px-3 py-2">
                <div class="text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="bmi_chip">IMC</div>
                <div id="bmi-display" class="text-sm font-semibold">—</div>
                <div id="bmi-category" class="text-[11px] text-slate-400/90 mt-1" data-i18n="bmi_hint">Informe altura e peso</div>
              </div>

              <div class="chip px-3 py-2">
                <div class="text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="ibw_chip">Peso ideal (Devine)</div>
                <div id="ibw-display" class="text-sm font-semibold">—</div>
                <div id="ibw-hint" class="text-[11px] text-slate-400/90 mt-1" data-i18n="ibw_hint">Requer sexo + altura</div>
              </div>

              <div class="chip px-3 py-2">
                <div class="text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="context_chip">Contexto</div>
                <div id="context-display" class="text-sm font-semibold">—</div>
                <div class="text-[11px] text-slate-400/90 mt-1" data-i18n="context_hint">Urgência influencia ARISCAT</div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass">
          <div class="px-4 sm:px-5 py-4">
            <div class="text-xs text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="section_airway_kicker">Via aérea</div>
            <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_airway_title">Via Aérea</h2>
            <p class="text-[11px] text-slate-300/70 mt-1" data-i18n="section_airway_hint">Mallampati e Índice de El-Ganzouri (EGRI)</p>

            <div class="mt-3 grid gap-3 sm:grid-cols-2">
              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="mallampati_label">Mallampati</span>
                <select id="mallampati" class="field px-3 py-2 text-sm">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="1">I</option>
                  <option value="2">II</option>
                  <option value="3">III</option>
                  <option value="4">IV</option>
                </select>
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="mouth_opening_label">Abertura bucal (cm)</span>
                <input id="mouth-opening" type="number" step="0.1" min="0" max="10"
                       class="field px-3 py-2 text-sm"
                       placeholder="4,5" data-i18n-placeholder="mouth_opening_ph" />
              </label>

              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="tmd_label">Distância tireomentoniana (cm)</span>
                <input id="tmd" type="number" step="0.1" min="0" max="15"
                       class="field px-3 py-2 text-sm"
                       placeholder="7,0" data-i18n-placeholder="tmd_ph" />
              </label>

              <label class="inline-flex items-center gap-2 mt-1 sm:mt-6">
                <input id="jaw-limited" type="checkbox"
                       class="h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span class="text-sm text-slate-200" data-i18n="jaw_limited_label">Não consegue protruir a mandíbula</span>
              </label>

              <div class="sm:col-span-2 glass-soft p-3">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-sm text-slate-200 font-medium" data-i18n="neck_mobility_title">Mobilidade cervical</div>
                  <div class="text-xs text-slate-300/80">
                    <span data-i18n="points_label">Pontos:</span>
                    <span id="neck-mobility-points" class="font-semibold">0</span>
                  </div>
                </div>
                <div class="mt-2">
                  <input id="neck-mobility" type="range" min="0" max="2" step="1" class="accent-blue-500" />
                </div>
                <div class="mt-2 text-[11px] text-slate-300/80">
                  <span id="neck-mobility-label">—</span>
                </div>
              </div>

              <div class="sm:col-span-2 glass-soft p-3">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-sm text-slate-200 font-medium" data-i18n="diff_history_title">História de intubação difícil</div>
                  <div class="text-xs text-slate-300/80">
                    <span data-i18n="points_label">Pontos:</span>
                    <span id="diff-history-points" class="font-semibold">0</span>
                  </div>
                </div>
                <div class="mt-2">
                  <input id="diff-history" type="range" min="0" max="2" step="1" class="accent-blue-500" />
                </div>
                <div class="mt-2 text-[11px] text-slate-300/80">
                  <span id="diff-history-label">—</span>
                </div>
              </div>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-1 text-xs">
              <div class="chip px-3 py-2 rounded-2xl">
                <div class="flex items-center justify-between">
                  <div class="text-slate-400/90 uppercase tracking-wide" data-i18n="egri_chip">El-Ganzouri (EGRI)</div>
                  <div id="egri-badge" class="badge-ok text-[11px] px-2 py-1">—</div>
                </div>
                <div class="mt-1 text-sm font-semibold">
                  <span id="egri-score">0</span>
                </div>
                <div class="text-[11px] text-slate-400/90 mt-1">
                  <span data-i18n="category_label">Categoria:</span>
                  <span id="egri-category" class="font-semibold">—</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="glass">
          <div class="px-4 sm:px-5 py-4">
            <div class="text-xs text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="section_stopbang_kicker">Sono</div>
            <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_stopbang_title">STOP-BANG (risco de AOS)</h2>
            <p class="text-[11px] text-slate-300/70 mt-1" data-i18n="section_stopbang_hint">Apenas rastreio (não diagnóstico)</p>

            <div class="mt-3 grid gap-2 sm:grid-cols-2 text-sm">
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-snoring" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="sb_snoring">Ronco alto.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-tired" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="sb_tired">Sonolência/fadiga diurna.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-observed" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="sb_observed">Apneia/engasgos observados.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-pressure" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="sb_pressure">Hipertensão.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-bmi" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" disabled />
                <span data-i18n="sb_bmi">IMC &gt; 35 kg/m² (auto).</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-age" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" disabled />
                <span data-i18n="sb_age">Idade &gt; 50 anos (auto).</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-neck" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="sb_neck">Circunferência do pescoço &gt; 40 cm.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-gender" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" disabled />
                <span data-i18n="sb_gender">Sexo masculino (auto).</span>
              </label>
            </div>

            <div class="mt-4 flex flex-wrap items-center gap-3 text-xs">
              <div class="chip px-3 py-1">
                <span data-i18n="score_label">Escore:</span>
                <span id="sb-score" class="font-semibold">0</span> / 8
              </div>
              <div class="chip px-3 py-1">
                <span data-i18n="category_label">Categoria:</span>
                <span id="sb-category" class="font-semibold">—</span>
              </div>
            </div>
          </div>
        </div>

        <div class="glass p-5 space-y-4">
          <div class="text-xs text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="section_risk_kicker">Risco</div>
          <h2 class="text-base sm:text-lg font-semibold mb-3" data-i18n="section_risk_title2">Escores</h2>

          <div class="chip p-4 rounded-2xl border border-slate-700/50 bg-slate-900/40">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold" data-i18n="rcri_title">RCRI</div>
                <div class="text-[11px] text-slate-400" data-i18n="rcri_title_en">(Revised Cardiac Risk Index)</div>
              </div>
              <div class="chip px-3 py-1 text-xs">
                <span data-i18n="score_label">Escore:</span>
                <span id="rcri-score" class="font-semibold">0</span> / 6
              </div>
            </div>

            <div class="mt-3 grid gap-2 sm:grid-cols-2 text-sm">
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="rcri-highrisk" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="rcri_highrisk">Cirurgia de alto risco (intraperitoneal, intratorácica, vascular suprainguinal).</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="rcri-ihd" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="rcri_ihd">Doença arterial coronariana/isquêmica.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="rcri-chf" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="rcri_chf">Insuficiência cardíaca congestiva.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="rcri-cva" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="rcri_cva">Doença cerebrovascular.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="rcri-insulin" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="rcri_insulin">Diabetes em uso de insulina.</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="rcri-creatinine" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="rcri_creat">Creatinina &gt; 2,0 mg/dL.</span>
              </label>
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-3 text-xs border-t border-slate-700/50 pt-2">
              <div class="chip px-3 py-1">
                <span data-i18n="category_label">Categoria:</span>
                <span id="rcri-category" class="font-semibold text-slate-200">—</span>
              </div>
              <div class="chip px-3 py-1 bg-blue-500/10 border-blue-500/20 text-blue-200">
                <span data-i18n="estimated_risk_label">Risco estimado:</span>
                <span id="rcri-risk" class="font-bold">—</span>
              </div>
            </div>
          </div>

          <div class="chip p-4 rounded-2xl border border-slate-700/50 bg-slate-900/40">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold" data-i18n="ariscat_title">ARISCAT</div>
                <div class="text-[11px] text-slate-400" data-i18n="ariscat_title_en">(Score for Postoperative Pulmonary Complications)</div>
              </div>
              <div class="chip px-3 py-1 text-xs">
                <span data-i18n="score_label">Escore:</span>
                <span id="ariscat-score" class="font-semibold">0</span>
              </div>
            </div>

            <div class="mt-3 grid gap-3 sm:grid-cols-2 text-sm">
              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="spo2_label">SpO₂ pré-op em ar ambiente (%)</span>
                <input id="ariscat-spo2" type="number" min="70" max="100"
                       class="field px-3 py-2 text-sm"
                       placeholder="98" data-i18n-placeholder="spo2_ph" />
              </label>
              <label class="flex flex-col">
                <span class="mb-1 text-xs text-slate-200" data-i18n="incision_label">Sítio da incisão</span>
                <select id="ariscat-incision" class="field px-3 py-2 text-sm">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="peripheral" data-i18n="inc_peripheral">Periférica</option>
                  <option value="upper-abdominal" data-i18n="inc_upper">Abdominal superior</option>
                  <option value="intrathoracic" data-i18n="inc_thoracic">Intratorácica</option>
                </select>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="ariscat-infection" class="h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="ariscat_infection">Infecção respiratória no último mês</span>
              </label>
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" id="ariscat-anemia" class="h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="ariscat_anemia">Hb ≤ 10 g/dL</span>
              </label>
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-3 text-xs border-t border-slate-700/50 pt-2">
              <div class="chip px-3 py-1">
                <span data-i18n="category_label">Categoria:</span>
                <span id="ariscat-category" class="font-semibold text-slate-200">—</span>
              </div>
              <div class="chip px-3 py-1 bg-blue-500/10 border-blue-500/20 text-blue-200">
                <span data-i18n="estimated_risk_label">Risco estimado:</span>
                <span id="ariscat-risk" class="font-bold">—</span>
              </div>
            </div>
          </div>

          <div class="chip p-4 rounded-2xl border border-slate-700/50 bg-slate-900/40">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="text-sm font-semibold" data-i18n="apfel_title2">Apfel (NVPO / PONV)</div>
              </div>
              <div class="chip px-3 py-1 text-xs">
                <span data-i18n="score_label">Escore:</span>
                <span id="apfel-score" class="font-semibold">0</span> / 4
              </div>
            </div>

            <div class="mt-3 grid gap-2 sm:grid-cols-2 text-sm">
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="apfel-nonsmoker" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="apfel_nonsmoker">Não fumante</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="apfel-history" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="apfel_history">História de NVPO ou cinetose</span>
              </label>
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="apfel-opioids" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" />
                <span data-i18n="apfel_opioids">Planeja opioide no pós-operatório</span>
              </label>
              <label class="inline-flex items-start gap-2 opacity-70">
                <input type="checkbox" id="apfel-female" class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800" disabled />
                <span data-i18n="apfel_female">Sexo feminino (auto)</span>
              </label>
            </div>

            <div class="mt-3 flex flex-wrap items-center gap-3 text-xs border-t border-slate-700/50 pt-2">
              <div class="chip px-3 py-1">
                 <span data-i18n="category_label">Categoria:</span>
                 <span id="apfel-category" class="font-semibold text-slate-200">—</span>
              </div>
              <div class="chip px-3 py-1 bg-blue-500/10 border-blue-500/20 text-blue-200">
                <span data-i18n="estimated_risk_label">Risco estimado:</span>
                <span id="apfel-risk" class="font-bold">—</span>
              </div>
            </div>
          </div>

        </div>
      </section>

      <section class="space-y-4">
        <div class="glass p-4 sm:p-5">
          <div class="flex items-start justify-between gap-3 mb-3">
            <div class="min-w-0">
              <div class="text-xs text-slate-400/90 uppercase tracking-wide mb-1" data-i18n="output_kicker">Resumo</div>
              <h2 class="text-base sm:text-lg font-semibold" data-i18n="output_title">Resumo Pré-Operatório (pronto para copiar)</h2>
              <p class="text-[11px] text-slate-300/70 mt-1" data-i18n="output_hint">
                Narrativa e escores gerados automaticamente. Revise antes do uso clínico.
              </p>
            </div>
            <button id="copy-output-btn"
                    class="btn btn-primary text-xs inline-flex items-center gap-1 shrink-0">
              <span data-i18n="copy">Copiar</span>
            </button>
          </div>

          <textarea id="output"
                    rows="20"
                    class="w-full rounded-2xl border border-slate-700/40 bg-slate-950/55 px-3 py-3 text-xs sm:text-sm font-mono leading-relaxed
                           focus:outline-none focus:ring-2 focus:ring-blue-500/30 focus:ring-offset-2 focus:ring-offset-slate-950 resize-y"
                    spellcheck="false"></textarea>

          <div class="mt-3 text-[10px] leading-snug text-slate-400/80" data-i18n="disclaimer">
            Esta ferramenta não substitui julgamento clínico, protocolos institucionais ou diretrizes. Escores são aproximações e devem ser verificados.
          </div>
        </div>
      </section>
    </main>
  </div>

  <div class="bottombar">
    <div class="max-w-6xl mx-auto px-3 sm:px-4 py-3 flex items-center justify-between gap-3">
      <div class="text-[11px] text-slate-300/70">
        <span data-i18n="footer_hint">Pronto para copiar para o prontuário.</span>
      </div>
      <button id="copy-output-btn-bottom"
              class="btn btn-primary text-xs inline-flex items-center gap-2">
        <span data-i18n="copy_summary">Copiar resumo</span>
      </button>
    </div>
  </div>

  <script>
    // -------------------------
    // i18n
    // -------------------------
    const I18N = {
      en: {
        app_title: "Preoperative Evaluation",
        app_subtitle: "Local, browser-based tool to structure perioperative risk assessment and generate a copy-ready summary. No data is sent to a server.",
        github_link: "View on GitHub",
        validation_title: "Please review the following:",
        select: "Select…",
        male: "Male",
        female: "Female",

        section_patient_kicker: "Patient",
        section_patient_title: "Patient & Surgical Data",
        local_only: "Local",
        age_label: "Age (years)",
        age_ph: "52",
        sex_label: "Sex at birth",
        height_label: "Height (cm)",
        height_ph: "170",
        weight_label: "Weight (kg)",
        weight_ph: "120",
        asa_label: "ASA classification",
        anesthesia_label: "Planned anesthesia",
        an_general: "General anesthesia",
        an_neuraxial: "Neuraxial anesthesia",
        an_block: "Nerve block",
        an_sedation: "Sedation / monitored care",
        procedure_label: "Planned procedure (free text)",
        procedure_ph: "Laparoscopic gastric bypass",
        duration_label: "Estimated duration (hours)",
        duration_ph: "3",
        emergency_label: "Emergency surgery",

        bmi_chip: "BMI",
        bmi_hint: "Enter height & weight",
        ibw_chip: "IBW (Devine)",
        ibw_hint: "Requires sex + height",
        context_chip: "Context",
        context_hint: "Emergency flag affects ARISCAT",

        section_airway_kicker: "Airway",
        section_airway_title: "Airway",
        section_airway_hint: "Mallampati and El-Ganzouri Risk Index (EGRI)",
        mallampati_label: "Mallampati",
        mouth_opening_label: "Mouth opening (cm)",
        mouth_opening_ph: "4.5",
        tmd_label: "Thyromental distance (cm)",
        tmd_ph: "7.0",
        jaw_limited_label: "Unable to protrude mandible",
        neck_mobility_title: "Neck mobility",
        diff_history_title: "History of difficult intubation",
        points_label: "Points:",
        egri_chip: "El-Ganzouri (EGRI)",
        category_label: "Category:",
        score_label: "Score:",

        section_stopbang_kicker: "Sleep",
        section_stopbang_title: "STOP-BANG (OSA risk)",
        section_stopbang_hint: "Screening only (not diagnostic)",
        sb_snoring: "Loud snoring.",
        sb_tired: "Daytime tiredness/fatigue.",
        sb_observed: "Observed apnea/gasping.",
        sb_pressure: "Hypertension.",
        sb_bmi: "BMI > 35 kg/m² (auto).",
        sb_age: "Age > 50 years (auto).",
        sb_neck: "Neck circumference > 40 cm.",
        sb_gender: "Male sex (auto).",

        section_risk_kicker: "Risk",
        section_risk_title2: "Scores",
        rcri_title: "RCRI — Revised Cardiac Risk Index",
        rcri_title_en: "",
        rcri_highrisk: "High-risk surgery (intraperitoneal, intrathoracic, suprainguinal vascular).",
        rcri_ihd: "Ischemic heart disease.",
        rcri_chf: "Congestive heart failure.",
        rcri_cva: "Cerebrovascular disease.",
        rcri_insulin: "Diabetes on insulin.",
        rcri_creat: "Creatinine > 2.0 mg/dL.",

        ariscat_title: "ARISCAT — Score for Postoperative Pulmonary Complications",
        ariscat_title_en: "",
        spo2_label: "Pre-op SpO₂ on room air (%)",
        spo2_ph: "98",
        ariscat_infection: "Respiratory infection in last month",
        ariscat_anemia: "Hb ≤ 10 g/dL",
        incision_label: "Surgical incision site",
        inc_peripheral: "Peripheral",
        inc_upper: "Upper abdominal",
        inc_thoracic: "Intrathoracic",
        estimated_risk_label: "Estimated risk:",

        apfel_title2: "Apfel (PONV / NVPO)",
        apfel_nonsmoker: "Non-smoker",
        apfel_history: "History of PONV or motion sickness",
        apfel_opioids: "Postoperative opioids planned",
        apfel_female: "Female sex (auto)",

        output_kicker: "Summary",
        output_title: "Preoperative Summary (copy-ready)",
        output_hint: "Auto-generated narrative and key scores. Please review before clinical use.",
        copy: "Copy",
        copied: "Copied!",
        disclaimer: "This tool does not replace clinical judgment, institutional protocols, or guidelines. Scores are approximations and must be verified.",
        footer_hint: "Ready to paste into your note.",
        copy_summary: "Copy summary",

        // Slider labels
        neck0: "Normal (>90°)",
        neck1: "Mild limitation (80–90°)",
        neck2: "Severe limitation (<80°)",
        hist0: "No history",
        hist1: "Questionable history",
        hist2: "Definite history",

        // Output phrases
        elective: "Elective surgery.",
        emergency: "Emergency surgery.",
        asa_unspecified: "ASA physical status not specified.",
        duration_unspecified: "Estimated surgical duration not specified.",
        anesthesia_unspecified: "anesthesia technique to be defined",
        scheduled_for: "scheduled for",
        under: "under",

        patient_intro_male: "This is a {age}-year-old male patient {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_female: "This is a {age}-year-old female patient {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_neutral: "This is a patient {scheduled_for} {procedure} {under} {anesthesia}.",

        bmi_line: "BMI {bmi} kg/m² ({bmiClass}).",
        bmi_missing: "BMI not available (missing weight or height).",
        ibw_line: "IBW (Devine) {ibw} kg.",
        ibw_missing: "IBW not available (requires sex + height).",
        asa_line: "ASA physical status {asa}.",
        duration_line: "Estimated surgical duration: {dur} h.",

        sb_line: "STOP-BANG: {score}/8 ({cat}).",
        rcri_line: "RCRI: {score}/6 ({cat}) — risk {risk}.",
        ariscat_line: "ARISCAT: {score} ({cat}) — risk {risk}.",
        apfel_line: "Apfel (PONV): {score}/4 ({cat}) — risk ~{risk}.",
        egri_line: "El-Ganzouri (difficult intubation): {score} ({cat}).",

        // Vent line
        vent_line: "If general anesthesia: consider lung-protective ventilation with tidal volume ≈ {vt} mL (≈ 7 mL/kg IBW, rounded to nearest 5 mL).",

        extras_title: "Additional considerations:",
        ponv_extra: "High PONV risk: consider multimodal prophylaxis.",
        osa_extra: "High STOP-BANG: consider intensified postoperative respiratory monitoring.",
        egri_extra: "EGRI high: plan airway strategy (video laryngoscope, team, rescue plan).",
        obesity_extra: "Severe obesity: consider higher risk of difficult airway, hypoxemia, and atelectasis.",

        // Categories & Risks
        rcri0: "Low", rcri1: "Low", rcri2: "Elevated", rcri3: "High",
        sb_low: "Low", sb_int: "Intermediate", sb_high: "High",
        egri_low: "Low risk", egri_high: "High risk",
        ar_low: "Low", ar_int: "Intermediate", ar_high: "High",
        apfel_low: "Low", apfel_int: "Intermediate", apfel_high: "High",
        badge_low: "Low", badge_high: "High"
      },

      pt: {
        app_title: "Avaliação Pré-operatória",
        app_subtitle: "Ferramenta local (no navegador) para estruturar avaliação perioperatória e gerar um resumo pronto para copiar. Nenhum dado é enviado para servidor.",
        github_link: "Ver no GitHub",
        validation_title: "Revise os itens abaixo:",
        select: "Selecionar…",
        male: "Masculino",
        female: "Feminino",

        section_patient_kicker: "Paciente",
        section_patient_title: "Dados do Paciente e Cirurgia",
        local_only: "Local",
        age_label: "Idade (anos)",
        age_ph: "52",
        sex_label: "Sexo ao nascimento",
        height_label: "Altura (cm)",
        height_ph: "170",
        weight_label: "Peso (kg)",
        weight_ph: "120",
        asa_label: "Classificação ASA",
        anesthesia_label: "Anestesia planejada",
        an_general: "Anestesia geral",
        an_neuraxial: "Anestesia neuroaxial",
        an_block: "Bloqueio de Nervo",
        an_sedation: "Sedação / cuidado monitorizado",
        procedure_label: "Procedimento planejado (texto livre)",
        procedure_ph: "Bypass gástrico laparoscópico",
        duration_label: "Duração estimada (horas)",
        duration_ph: "3",
        emergency_label: "Cirurgia de urgência/emergência",

        bmi_chip: "IMC",
        bmi_hint: "Informe altura e peso",
        ibw_chip: "Peso ideal (Devine)",
        ibw_hint: "Requer sexo + altura",
        context_chip: "Contexto",
        context_hint: "Urgência influencia ARISCAT",

        section_airway_kicker: "Via aérea",
        section_airway_title: "Via Aérea",
        section_airway_hint: "Mallampati e Índice de El-Ganzouri (EGRI)",
        mallampati_label: "Mallampati",
        mouth_opening_label: "Abertura bucal (cm)",
        mouth_opening_ph: "4,5",
        tmd_label: "Distância tireomentoniana (cm)",
        tmd_ph: "7,0",
        jaw_limited_label: "Não consegue protruir a mandíbula",
        neck_mobility_title: "Mobilidade cervical",
        diff_history_title: "História de intubação difícil",
        points_label: "Pontos:",
        egri_chip: "El-Ganzouri (EGRI)",
        category_label: "Categoria:",
        score_label: "Escore:",

        section_stopbang_kicker: "Sono",
        section_stopbang_title: "STOP-BANG (risco de AOS)",
        section_stopbang_hint: "Apenas rastreio (não diagnóstico)",
        sb_snoring: "Ronco alto.",
        sb_tired: "Sonolência/fadiga diurna.",
        sb_observed: "Apneia/engasgos observados.",
        sb_pressure: "Hipertensão.",
        sb_bmi: "IMC > 35 kg/m² (auto).",
        sb_age: "Idade > 50 anos (auto).",
        sb_neck: "Circunferência do pescoço > 40 cm.",
        sb_gender: "Sexo masculino (auto).",

        section_risk_kicker: "Risco",
        section_risk_title2: "Escores",
        rcri_title: "RCRI — Índice de Risco Cardíaco Revisado",
        rcri_title_en: "(Revised Cardiac Risk Index)",
        rcri_highrisk: "Cirurgia de alto risco (intraperitoneal, intratorácica, vascular suprainguinal).",
        rcri_ihd: "Doença arterial coronariana/isquêmica.",
        rcri_chf: "Insuficiência cardíaca congestiva.",
        rcri_cva: "Doença cerebrovascular.",
        rcri_insulin: "Diabetes em uso de insulina.",
        rcri_creat: "Creatinina > 2,0 mg/dL.",

        ariscat_title: "ARISCAT — Escore de complicação pulmonar pós-operatória",
        ariscat_title_en: "(Score for Postoperative Pulmonary Complications)",
        spo2_label: "SpO₂ pré-op em ar ambiente (%)",
        spo2_ph: "98",
        ariscat_infection: "Infecção respiratória no último mês",
        ariscat_anemia: "Hb ≤ 10 g/dL",
        incision_label: "Sítio da incisão",
        inc_peripheral: "Periférica",
        inc_upper: "Abdominal superior",
        inc_thoracic: "Intratorácica",
        estimated_risk_label: "Risco estimado:",

        apfel_title2: "Apfel (NVPO / PONV)",
        apfel_nonsmoker: "Não fumante",
        apfel_history: "História de NVPO ou cinetose",
        apfel_opioids: "Planeja opioide no pós-operatório",
        apfel_female: "Sexo feminino (auto)",

        output_kicker: "Resumo",
        output_title: "Resumo Pré-Operatório (pronto para copiar)",
        output_hint: "Narrativa e escores gerados automaticamente. Revise antes do uso clínico.",
        copy: "Copiar",
        copied: "Copiado!",
        disclaimer: "Esta ferramenta não substitui julgamento clínico, protocolos institucionais ou diretrizes. Escores são aproximações e devem ser verificados.",
        footer_hint: "Pronto para colar no prontuário.",
        copy_summary: "Copiar resumo",

        // Slider labels
        neck0: "Normal (>90°)",
        neck1: "Limitação leve (80–90°)",
        neck2: "Limitação grave (<80°)",
        hist0: "Sem história",
        hist1: "História duvidosa",
        hist2: "História definitiva",

        // Output phrases
        elective: "Cirurgia eletiva.",
        emergency: "Cirurgia de urgência/emergência.",
        asa_unspecified: "Estado físico ASA não informado.",
        duration_unspecified: "Duração estimada não informada.",
        anesthesia_unspecified: "técnica anestésica a definir",
        scheduled_for: "agendado(a) para",
        under: "sob",

        patient_intro_male: "Paciente masculino de {age} anos {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_female: "Paciente feminino de {age} anos {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_neutral: "Paciente {scheduled_for} {procedure} {under} {anesthesia}.",

        bmi_line: "IMC {bmi} kg/m² ({bmiClass}).",
        bmi_missing: "IMC indisponível (faltam altura e/ou peso).",
        ibw_line: "Peso ideal (Devine) {ibw} kg.",
        ibw_missing: "Peso ideal indisponível (requer sexo + altura).",
        asa_line: "Estado físico ASA {asa}.",
        duration_line: "Duração estimada: {dur} h.",

        sb_line: "STOP-BANG: {score}/8 ({cat}).",
        rcri_line: "RCRI: {score}/6 ({cat}) — risco {risk}.",
        ariscat_line: "ARISCAT: {score} ({cat}) — risco {risk}.",
        apfel_line: "Apfel: {score}/4 ({cat}) — risco estimado ~{risk}.",
        egri_line: "El-Ganzouri (intubação difícil): {score} ({cat}).",

        vent_line: "Se anestesia geral: considerar ventilação protetora com volume corrente ≈ {vt} mL (≈ 7 mL/kg do peso ideal, arredondado para múltiplo de 5 mL).",

        extras_title: "Pontos adicionais:",
        ponv_extra: "Risco elevado de NVPO: considerar profilaxia multimodal.",
        osa_extra: "STOP-BANG alto: considerar monitorização respiratória pós-op intensificada.",
        egri_extra: "EGRI alto: planejar estratégia de via aérea (videolaringoscópio, equipe, plano de resgate).",
        obesity_extra: "Obesidade grave: considerar maior risco de via aérea difícil, hipóxia e atelectasia.",

        // Categories & Risks
        rcri0: "Baixo", rcri1: "Baixo", rcri2: "Elevado", rcri3: "Alto",
        sb_low: "Baixo", sb_int: "Intermediário", sb_high: "Alto",
        egri_low: "Baixo risco", egri_high: "Alto risco",
        ar_low: "Baixo", ar_int: "Intermediário", ar_high: "Alto",
        apfel_low: "Baixo", apfel_int: "Intermediário", apfel_high: "Alto",
        badge_low: "Baixo", badge_high: "Alto"
      }
    };

    // Default: Portuguese
    const state = { lang: "pt" };

    function t(key) {
      return (I18N[state.lang] && I18N[state.lang][key]) ?? I18N.en[key] ?? key;
    }

    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = t(key);
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        el.setAttribute("placeholder", t(key));
      });
      document.querySelectorAll("option[data-i18n]").forEach(opt => {
        const key = opt.getAttribute("data-i18n");
        opt.textContent = t(key);
      });
    }

    // -------------------------
    // Helpers
    // -------------------------
    function toNumber(value) {
      const n = parseFloat(String(value).replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function fmt1(n) { return (Math.round(n * 10) / 10).toFixed(1); }
    function clamp(num, min, max) { return Math.min(Math.max(num, min), max); }
    function template(str, vars) {
      return str.replace(/\{(\w+)\}/g, (_, k) => (vars[k] ?? ""));
    }
    function roundToNearest5(x) {
      return Math.round(x / 5) * 5;
    }

    function classifyBMI(bmi) {
      if (bmi == null) return { label: "—" };
      if (bmi < 18.5) return { label: state.lang === "pt" ? "Baixo peso" : "Underweight" };
      if (bmi < 25) return { label: state.lang === "pt" ? "Normal" : "Normal" };
      if (bmi < 30) return { label: state.lang === "pt" ? "Sobrepeso" : "Overweight" };
      if (bmi < 35) return { label: state.lang === "pt" ? "Obesidade I" : "Obesity I" };
      if (bmi < 40) return { label: state.lang === "pt" ? "Obesidade II" : "Obesity II" };
      return { label: state.lang === "pt" ? "Obesidade III" : "Obesity III" };
    }

    function classifyStopBang(score) {
      if (score <= 2) return t("sb_low");
      if (score <= 4) return t("sb_int");
      return t("sb_high");
    }

    function classifyRCRI(score) {
      if (score === 0) return t("rcri0");
      if (score === 1) return t("rcri1");
      if (score === 2) return t("rcri2");
      return t("rcri3");
    }

    function getRCRIRisk(score) {
      if (score === 0) return "0.5%";
      if (score === 1) return "1.1%";
      if (score === 2) return "5%";
      return "10%"; // >= 3
    }

    function devineIBW(sex, heightCm) {
      if (!sex || heightCm == null) return null;
      const inches = heightCm / 2.54;
      const base = sex === "male" ? 50 : 45.5;
      const ibw = base + 2.3 * (inches - 60);
      return Math.round(ibw * 10) / 10;
    }

    function apfelRiskPercent(score) {
      const map = { 0: "10%", 1: "21%", 2: "39%", 3: "61%", 4: "79%" };
      return map[clamp(score, 0, 4)] ?? "—";
    }

    function computeARISCAT(age, spo2, infection, anemia, incision, durationHours, emergency) {
      let score = 0;
      if (age != null) {
        if (age >= 51 && age <= 80) score += 3;
        else if (age >= 81) score += 16;
      }
      if (spo2 != null) {
        if (spo2 >= 96) score += 0;
        else if (spo2 >= 91 && spo2 <= 95) score += 8;
        else score += 24;
      }
      if (infection) score += 17;
      if (anemia) score += 11;
      if (incision === "upper-abdominal") score += 15;
      else if (incision === "intrathoracic") score += 24;
      if (durationHours != null) {
        if (durationHours < 2) score += 0;
        else if (durationHours <= 3) score += 16;
        else score += 23;
      }
      if (emergency) score += 8;

      let categoryKey, riskText;
      if (score < 26) {
        categoryKey = "ar_low";
        riskText = "1.6%";
      } else if (score <= 44) {
        categoryKey = "ar_int";
        riskText = "13.3%";
      } else {
        categoryKey = "ar_high";
        riskText = "42.1%";
      }

      return { score, category: t(categoryKey), risk: riskText };
    }

    function computeEGRI({ mallampati, mouthOpening, tmd, jawLimited, weightKg, neckMobilityPoints, diffHistoryPoints }) {
      let score = 0;
      if (mallampati === 2) score += 1;
      if (mallampati === 3 || mallampati === 4) score += 2;
      if (mouthOpening != null) {
        if (mouthOpening < 3.5) score += 2;
        else if (mouthOpening < 4.0) score += 1;
      }
      if (tmd != null) {
        if (tmd < 6) score += 2;
        else if (tmd < 6.5) score += 1;
      }
      if (jawLimited) score += 1;
      if (weightKg != null) {
        if (weightKg >= 90 && weightKg <= 110) score += 1;
        else if (weightKg > 110) score += 2;
      }
      score += neckMobilityPoints || 0;
      score += diffHistoryPoints || 0;

      const high = score >= 4;
      const category = high ? t("egri_high") : t("egri_low");
      const badgeText = high ? t("badge_high") : t("badge_low");
      const badgeClass = high ? "badge-bad" : "badge-ok";

      return { score, category, badgeText, badgeClass };
    }

    function computeSTOPBANG({ snoring, tired, observed, pressure, bmi, age, neckLarge, sex }) {
      let score = 0;
      if (snoring) score += 1;
      if (tired) score += 1;
      if (observed) score += 1;
      if (pressure) score += 1;
      
      const bmiHigh = bmi != null && bmi >= 35;
      if (bmiHigh) score += 1;
      
      const ageHigh = age != null && age > 50;
      if (ageHigh) score += 1;
      
      if (neckLarge) score += 1;
      
      const male = sex === "male";
      if (male) score += 1;

      const category = classifyStopBang(score);
      return { score, category, bmiHigh, ageHigh, male };
    }

    function computeRCRI({ highRiskSurgery, ischemicHeartDisease, chf, cva, insulin, creatinineHigh }) {
      let score = 0;
      if (highRiskSurgery) score += 1;
      if (ischemicHeartDisease) score += 1;
      if (chf) score += 1;
      if (cva) score += 1;
      if (insulin) score += 1;
      if (creatinineHigh) score += 1;

      const category = classifyRCRI(score);
      const risk = getRCRIRisk(score);
      return { score, category, risk };
    }

    function computeApfel({ sex, nonsmoker, historyPONV, opioids }) {
      let score = 0;
      if (sex === "female") score += 1;
      if (nonsmoker) score += 1;
      if (historyPONV) score += 1;
      if (opioids) score += 1;

      const risk = apfelRiskPercent(score);
      let categoryKey;
      if (score <= 1) categoryKey = "apfel_low";
      else if (score === 2) categoryKey = "apfel_int";
      else categoryKey = "apfel_high";

      return { score, risk, category: t(categoryKey) };
    }

    // -------------------------
    // DOM + main update
    // -------------------------
    function updateDerivedMetrics() {
      const age = toNumber(document.getElementById("age").value);
      const sex = document.getElementById("sex").value;
      const height = toNumber(document.getElementById("height").value);
      const weight = toNumber(document.getElementById("weight").value);
      const emergency = document.getElementById("emergency-surgery").checked;

      let bmiValue = null;
      if (height != null && weight != null && height > 0) {
        const hMeters = height / 100;
        bmiValue = weight / (hMeters * hMeters);
      }

      const bmiDisplay = document.getElementById("bmi-display");
      const bmiCategory = document.getElementById("bmi-category");
      if (bmiValue != null) {
        const cls = classifyBMI(bmiValue);
        bmiDisplay.textContent = fmt1(bmiValue);
        bmiCategory.textContent = template(t("bmi_line"), {
          bmi: fmt1(bmiValue),
          bmiClass: cls.label
        });
      } else {
        bmiDisplay.textContent = "—";
        bmiCategory.textContent = t("bmi_hint");
      }

      const ibw = devineIBW(sex, height);
      const ibwDisplay = document.getElementById("ibw-display");
      const ibwHint = document.getElementById("ibw-hint");
      if (ibw != null) {
        ibwDisplay.textContent = fmt1(ibw);
        ibwHint.textContent = template(t("ibw_line"), { ibw: fmt1(ibw) });
      } else {
        ibwDisplay.textContent = "—";
        ibwHint.textContent = t("ibw_hint");
      }

      const contextDisplay = document.getElementById("context-display");
      if (emergency) {
        contextDisplay.textContent = t("emergency");
      } else {
        contextDisplay.textContent = t("elective");
      }

      const sbBmi = document.getElementById("sb-bmi");
      const sbAge = document.getElementById("sb-age");
      const sbGender = document.getElementById("sb-gender");

      const bmiHigh = bmiValue != null && bmiValue >= 35;
      const ageHigh = age != null && age > 50;
      const male = sex === "male";

      sbBmi.checked = bmiHigh;
      sbAge.checked = ageHigh;
      sbGender.checked = male;

      // Update Apfel auto checkbox
      const apfelFemale = document.getElementById("apfel-female");
      if (apfelFemale) {
        apfelFemale.checked = (sex === "female");
      }

      return { bmiValue, ibw };
    }

    function updateScoresAndOutput() {
      const { bmiValue, ibw } = updateDerivedMetrics();

      const age = toNumber(document.getElementById("age").value);
      const sex = document.getElementById("sex").value;
      const height = toNumber(document.getElementById("height").value);
      const weight = toNumber(document.getElementById("weight").value);
      const asa = document.getElementById("asa").value;
      const anesthesiaType = document.getElementById("anesthesia-type").value;
      const procedure = document.getElementById("procedure").value.trim();
      const duration = toNumber(document.getElementById("surgery-duration").value);
      const emergency = document.getElementById("emergency-surgery").checked;

      // Airway inputs
      const mallampatiVal = toNumber(document.getElementById("mallampati").value);
      const mouthOpening = toNumber(document.getElementById("mouth-opening").value);
      const tmd = toNumber(document.getElementById("tmd").value);
      const jawLimited = document.getElementById("jaw-limited").checked;
      const neckMobilityPoints = toNumber(document.getElementById("neck-mobility").value) || 0;
      const diffHistoryPoints = toNumber(document.getElementById("diff-history").value) || 0;

      // STOP-BANG manual
      const sbSnoring = document.getElementById("sb-snoring").checked;
      const sbTired = document.getElementById("sb-tired").checked;
      const sbObserved = document.getElementById("sb-observed").checked;
      const sbPressure = document.getElementById("sb-pressure").checked;
      const sbNeck = document.getElementById("sb-neck").checked;

      // RCRI
      const rcriHighRisk = document.getElementById("rcri-highrisk").checked;
      const rcriIHD = document.getElementById("rcri-ihd").checked;
      const rcriCHF = document.getElementById("rcri-chf").checked;
      const rcriCVA = document.getElementById("rcri-cva").checked;
      const rcriInsulin = document.getElementById("rcri-insulin").checked;
      const rcriCreat = document.getElementById("rcri-creatinine").checked;

      // ARISCAT
      const arSpO2 = toNumber(document.getElementById("ariscat-spo2").value);
      const arInfection = document.getElementById("ariscat-infection").checked;
      const arAnemia = document.getElementById("ariscat-anemia").checked;
      const arIncision = document.getElementById("ariscat-incision").value;

      // Apfel
      const apfelNonsmoker = document.getElementById("apfel-nonsmoker").checked;
      const apfelHistory = document.getElementById("apfel-history").checked;
      const apfelOpioids = document.getElementById("apfel-opioids").checked;

      // Computations
      const sbResult = computeSTOPBANG({
        snoring: sbSnoring, tired: sbTired, observed: sbObserved, pressure: sbPressure,
        bmi: bmiValue, age, neckLarge: sbNeck, sex
      });
      document.getElementById("sb-score").textContent = sbResult.score;
      document.getElementById("sb-category").textContent = sbResult.category;

      const rcri = computeRCRI({
        highRiskSurgery: rcriHighRisk, ischemicHeartDisease: rcriIHD, chf: rcriCHF,
        cva: rcriCVA, insulin: rcriInsulin, creatinineHigh: rcriCreat
      });
      document.getElementById("rcri-score").textContent = rcri.score;
      document.getElementById("rcri-category").textContent = rcri.category;
      document.getElementById("rcri-risk").textContent = rcri.risk;

      const ariscat = computeARISCAT(age, arSpO2, arInfection, arAnemia, arIncision, duration, emergency);
      document.getElementById("ariscat-score").textContent = ariscat.score;
      document.getElementById("ariscat-category").textContent = ariscat.category;
      document.getElementById("ariscat-risk").textContent = ariscat.risk;

      const apfel = computeApfel({ sex, nonsmoker: apfelNonsmoker, historyPONV: apfelHistory, opioids: apfelOpioids });
      document.getElementById("apfel-score").textContent = apfel.score;
      document.getElementById("apfel-category").textContent = apfel.category;
      document.getElementById("apfel-risk").textContent = apfel.risk;

      const egriResult = computeEGRI({
        mallampati: mallampatiVal, mouthOpening, tmd, jawLimited, weightKg: weight,
        neckMobilityPoints, diffHistoryPoints
      });
      document.getElementById("egri-score").textContent = egriResult.score;
      document.getElementById("egri-category").textContent = egriResult.category;
      const egriBadge = document.getElementById("egri-badge");
      egriBadge.textContent = egriResult.badgeText;
      egriBadge.className = egriResult.badgeClass + " text-[11px] px-2 py-1";

      // Slider labels
      const neckLabel = document.getElementById("neck-mobility-label");
      if (neckLabel) {
        if (neckMobilityPoints === 0) neckLabel.textContent = t("neck0");
        else if (neckMobilityPoints === 1) neckLabel.textContent = t("neck1");
        else neckLabel.textContent = t("neck2");
      }
      const neckPointsSpan = document.getElementById("neck-mobility-points");
      if (neckPointsSpan) neckPointsSpan.textContent = neckMobilityPoints;

      const diffLabel = document.getElementById("diff-history-label");
      if (diffLabel) {
        if (diffHistoryPoints === 0) diffLabel.textContent = t("hist0");
        else if (diffHistoryPoints === 1) diffLabel.textContent = t("hist1");
        else diffLabel.textContent = t("hist2");
      }
      const diffPointsSpan = document.getElementById("diff-history-points");
      if (diffPointsSpan) diffPointsSpan.textContent = diffHistoryPoints;

      buildOutput({ age, sex, height, weight, asa, anesthesiaType, procedure, duration, emergency, bmi: bmiValue, ibw, sbResult, rcri, ariscat, apfel, egriResult });
    }

    function buildOutput(ctx) {
      const { age, sex, asa, anesthesiaType, procedure, duration, emergency, bmi, ibw, sbResult, rcri, ariscat, apfel, egriResult } = ctx;
      const lines = [];

      const anesthesiaText = anesthesiaType
        ? document.querySelector(`#anesthesia-type option[value="${anesthesiaType}"]`)?.textContent
        : t("anesthesia_unspecified");

      const procText = procedure || (state.lang === "pt" ? "cirurgia eletiva" : "elective surgery");
      let introTemplate;
      if (sex === "male") introTemplate = t("patient_intro_male");
      else if (sex === "female") introTemplate = t("patient_intro_female");
      else introTemplate = t("patient_intro_neutral");

      lines.push(template(introTemplate, {
        age: age != null ? age : "",
        scheduled_for: t("scheduled_for"),
        procedure: procText,
        under: t("under"),
        anesthesia: anesthesiaText
      }).trim());

      lines.push(emergency ? t("emergency") : t("elective"));

      if (asa) lines.push(template(t("asa_line"), { asa }));
      else lines.push(t("asa_unspecified"));

      if (duration != null) lines.push(template(t("duration_line"), { dur: fmt1(duration) }));
      else lines.push(t("duration_unspecified"));

      if (bmi != null) {
        const cls = classifyBMI(bmi);
        lines.push(template(t("bmi_line"), { bmi: fmt1(bmi), bmiClass: cls.label }));
      } else lines.push(t("bmi_missing"));

      if (ibw != null) lines.push(template(t("ibw_line"), { ibw: fmt1(ibw) }));
      else lines.push(t("ibw_missing"));

      lines.push(template(t("sb_line"), { score: sbResult.score, cat: sbResult.category }));
      lines.push(template(t("rcri_line"), { score: rcri.score, cat: rcri.category, risk: rcri.risk }));
      lines.push(template(t("ariscat_line"), { score: ariscat.score, cat: ariscat.category, risk: ariscat.risk }));
      lines.push(template(t("apfel_line"), { score: apfel.score, cat: apfel.category, risk: apfel.risk }));
      lines.push(template(t("egri_line"), { score: egriResult.score, cat: egriResult.category }));

      if (anesthesiaType === "general" && ibw != null) {
        const vtRaw = ibw * 7;
        const vt = roundToNearest5(vtRaw);
        lines.push(template(t("vent_line"), { vt }));
      }

      const extras = [];
      if (apfel.score >= 3) extras.push(t("ponv_extra"));
      if (sbResult.score >= 5) extras.push(t("osa_extra"));
      if (egriResult.score >= 4) extras.push(t("egri_extra"));
      if (bmi != null && bmi >= 40) extras.push(t("obesity_extra"));

      if (extras.length > 0) {
        lines.push("");
        lines.push(t("extras_title"));
        extras.forEach(e => lines.push("• " + e));
      }

      document.getElementById("output").value = lines.join("\n");
    }

    // -------------------------
    // Validation
    // -------------------------
    function validateInputs() {
      const issues = [];
      const age = toNumber(document.getElementById("age").value);
      const height = toNumber(document.getElementById("height").value);
      const weight = toNumber(document.getElementById("weight").value);

      if (age == null || age < 16 || age > 100) {
        issues.push(state.lang === "pt"
          ? "Idade fora do intervalo típico (16–100 anos) ou não informada."
          : "Age missing or outside typical range (16–100 years).");
      }
      if (height == null || height < 120 || height > 220) {
        issues.push(state.lang === "pt"
          ? "Altura fora do intervalo típico (120–220 cm) ou não informada."
          : "Height missing or outside typical range (120–220 cm).");
      }
      if (weight == null || weight < 30 || weight > 300) {
        issues.push(state.lang === "pt"
          ? "Peso fora do intervalo típico (30–300 kg) ou não informado."
          : "Weight missing or outside typical range (30–300 kg).");
      }

      const banner = document.getElementById("validation-banner");
      const list = document.getElementById("validation-list");
      if (!banner || !list) return;

      if (issues.length > 0) {
        banner.classList.remove("hidden");
        list.innerHTML = "";
        issues.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = msg;
          list.appendChild(li);
        });
      } else {
        banner.classList.add("hidden");
        list.innerHTML = "";
      }
    }

    // -------------------------
    // Copy
    // -------------------------
    function setupCopyButtons() {
      function doCopy() {
        const text = document.getElementById("output").value;
        if (!text) return;
        navigator.clipboard.writeText(text).catch(() => {});
      }

      const mainBtn = document.getElementById("copy-output-btn");
      const bottomBtn = document.getElementById("copy-output-btn-bottom");

      if (mainBtn) {
        mainBtn.addEventListener("click", () => {
          doCopy();
          mainBtn.classList.add("ring-2", "ring-emerald-400/60");
          setTimeout(() => mainBtn.classList.remove("ring-2", "ring-emerald-400/60"), 600);
        });
      }
      if (bottomBtn) {
        bottomBtn.addEventListener("click", () => {
          doCopy();
          bottomBtn.classList.add("ring-2", "ring-emerald-400/60");
          setTimeout(() => bottomBtn.classList.remove("ring-2", "ring-emerald-400/60"), 600);
        });
      }
    }

    // -------------------------
    // Language toggle
    // -------------------------
    function setupLanguageToggle() {
      const ptBtn = document.getElementById("lang-pt-btn");
      const enBtn = document.getElementById("lang-en-btn");

      function updateButtons() {
        if (state.lang === "pt") {
          ptBtn.classList.add("bg-blue-500", "text-white");
          enBtn.classList.remove("bg-blue-500", "text-white");
          enBtn.classList.add("text-slate-200");
        } else {
          enBtn.classList.add("bg-blue-500", "text-white");
          ptBtn.classList.remove("bg-blue-500", "text-white");
          ptBtn.classList.add("text-slate-200");
        }
      }

      ptBtn.addEventListener("click", () => {
        state.lang = "pt";
        applyI18n();
        updateDerivedMetrics();
        updateScoresAndOutput();
        updateButtons();
      });

      enBtn.addEventListener("click", () => {
        state.lang = "en";
        applyI18n();
        updateDerivedMetrics();
        updateScoresAndOutput();
        updateButtons();
      });

      updateButtons();
    }

    // -------------------------
    // Wiring
    // -------------------------
    function setupListeners() {
      const inputs = [
        "age","sex","height","weight","asa","anesthesia-type","procedure",
        "surgery-duration","emergency-surgery",
        "mallampati","mouth-opening","tmd","jaw-limited","neck-mobility","diff-history",
        "sb-snoring","sb-tired","sb-observed","sb-pressure","sb-neck",
        "rcri-highrisk","rcri-ihd","rcri-chf","rcri-cva","rcri-insulin","rcri-creatinine",
        "ariscat-spo2","ariscat-infection","ariscat-anemia","ariscat-incision",
        "apfel-nonsmoker","apfel-history","apfel-opioids"
      ];

      inputs.forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = el.tagName === "SELECT" || el.type === "checkbox" || el.type === "range" ? "change" : "input";
        el.addEventListener(evt, () => {
          updateScoresAndOutput();
          validateInputs();
        });
      });
    }

    // -------------------------
    // Init
    // -------------------------
    document.addEventListener("DOMContentLoaded", () => {
      applyI18n();
      setupLanguageToggle();
      setupCopyButtons();
      setupListeners();
      updateScoresAndOutput();
      validateInputs();
    });
  </script>
</body>
</html>
