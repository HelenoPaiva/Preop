<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Preoperative Evaluation / Avaliação Pré-operatória</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Avoid iOS zoom on inputs */
    input, select, textarea { font-size: 16px; }
    /* Make range sliders look decent everywhere */
    input[type="range"] { width: 100%; }
  </style>
</head>

<body class="bg-slate-950 text-slate-100 min-h-screen">
  <div class="max-w-6xl mx-auto px-3 sm:px-4 py-4 sm:py-6">
    <!-- Header -->
    <header class="mb-4 sm:mb-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
        <div class="min-w-0">
          <h1 class="text-xl sm:text-3xl font-semibold tracking-tight leading-tight">
            Preoperative Evaluation / Avaliação Pré-operatória
          </h1>
          <p class="text-xs sm:text-sm text-slate-300 mt-1 max-w-2xl" data-i18n="app_subtitle">
            Ferramenta local (no navegador) para estruturar avaliação perioperatória e gerar um resumo pronto para copiar.
            Nenhum dado é enviado para servidor.
          </p>
        </div>

        <div class="flex items-center justify-between gap-3 sm:justify-end w-full sm:w-auto">
          <!-- Language toggle -->
          <div class="inline-flex items-center gap-2 rounded-full bg-slate-800 border border-slate-600 px-2 py-1 text-xs shrink-0">
            <span class="text-slate-300 select-none">EN-PT</span>
            <div class="inline-flex items-center rounded-full bg-slate-900/60 border border-slate-700 p-0.5">
              <button id="lang-pt-btn"
                      class="px-2 py-1 rounded-full bg-blue-500 text-white font-medium"
                      aria-label="Português">
                PT
              </button>
              <button id="lang-en-btn"
                      class="px-2 py-1 rounded-full text-slate-200"
                      aria-label="English">
                EN
              </button>
            </div>
          </div>

          <a href="https://github.com/HelenoPaiva/Preoperative-Composer"
             target="_blank"
             class="text-xs sm:text-sm text-blue-400 hover:text-blue-300 underline decoration-dotted shrink-0 whitespace-nowrap">
            <span data-i18n="github_link">Ver no GitHub</span>
          </a>
        </div>
      </div>
    </header>

    <!-- Validation banner -->
    <div id="validation-banner"
         class="hidden mb-4 rounded-2xl border border-rose-700/70 bg-rose-950/40 px-4 py-3 text-sm">
      <div class="font-semibold text-rose-200" data-i18n="validation_title">Revise os itens abaixo:</div>
      <ul id="validation-list" class="mt-2 list-disc pl-5 text-rose-100/90 space-y-1"></ul>
    </div>

    <!-- Main layout -->
    <main class="grid gap-4 sm:gap-6 lg:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)]">
      <!-- LEFT: Inputs -->
      <section class="space-y-4">
        <!-- Patient & Surgical Data -->
        <div class="bg-slate-900/70 border border-slate-700 rounded-2xl shadow-lg shadow-black/40">
          <div class="px-4 sm:px-5 py-4">
            <div class="flex items-start justify-between gap-3">
              <div>
                <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_patient_title">Dados do Paciente e Cirurgia</h2>
                <p class="text-xs text-slate-400 mt-0.5" data-i18n="section_patient_hint">Demografia e contexto do procedimento</p>
              </div>
            </div>

            <div class="mt-3 grid gap-3 sm:grid-cols-2">
              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="age_label">Idade (anos)</span>
                <input id="age" type="number" min="16" max="100"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="52" data-i18n-placeholder="age_ph" />
              </label>

              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="sex_label">Sexo ao nascimento</span>
                <select id="sex"
                        class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="male" data-i18n="male">Masculino</option>
                  <option value="female" data-i18n="female">Feminino</option>
                </select>
              </label>

              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="height_label">Altura (cm)</span>
                <input id="height" type="number" min="120" max="220"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="170" data-i18n-placeholder="height_ph" />
              </label>

              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="weight_label">Peso (kg)</span>
                <input id="weight" type="number" min="30" max="300"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="120" data-i18n-placeholder="weight_ph" />
              </label>

              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="asa_label">Classificação ASA</span>
                <select id="asa"
                        class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="I">ASA I</option>
                  <option value="II">ASA II</option>
                  <option value="III">ASA III</option>
                  <option value="IV">ASA IV</option>
                  <option value="V">ASA V</option>
                </select>
              </label>

              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="anesthesia_label">Anestesia planejada</span>
                <select id="anesthesia-type"
                        class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="general" data-i18n="an_general">Anestesia geral</option>
                  <option value="neuraxial" data-i18n="an_neuraxial">Anestesia neuroaxial</option>
                  <option value="regional" data-i18n="an_regional">Anestesia regional periférica</option>
                  <option value="sedation" data-i18n="an_sedation">Sedação / cuidado monitorizado</option>
                </select>
              </label>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-2">
              <label class="flex flex-col text-sm sm:col-span-2">
                <span class="mb-1 text-slate-200" data-i18n="procedure_label">Procedimento planejado (texto livre)</span>
                <input id="procedure"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="Bypass gástrico laparoscópico" data-i18n-placeholder="procedure_ph" />
              </label>

              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="duration_label">Duração estimada (horas)</span>
                <input id="surgery-duration" type="number" step="0.5" min="0" max="12"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="3" data-i18n-placeholder="duration_ph" />
              </label>

              <label class="inline-flex items-center gap-2 text-sm mt-1 sm:mt-6">
                <input id="emergency-surgery" type="checkbox"
                       class="h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span class="text-slate-200" data-i18n="emergency_label">Cirurgia de urgência/emergência</span>
              </label>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-3 text-xs">
              <div class="rounded-xl bg-slate-800/80 border border-slate-700 px-3 py-2">
                <div class="text-slate-400 uppercase tracking-wide mb-1" data-i18n="bmi_chip">IMC</div>
                <div id="bmi-display" class="text-sm font-semibold">—</div>
                <div id="bmi-category" class="text-[11px] text-slate-400 mt-1" data-i18n="bmi_hint">Informe altura e peso</div>
              </div>

              <div class="rounded-xl bg-slate-800/80 border border-slate-700 px-3 py-2">
                <div class="text-slate-400 uppercase tracking-wide mb-1" data-i18n="ibw_chip">Peso ideal (Devine)</div>
                <div id="ibw-display" class="text-sm font-semibold">—</div>
                <div id="ibw-hint" class="text-[11px] text-slate-400 mt-1" data-i18n="ibw_hint">Requer sexo + altura</div>
              </div>

              <div class="rounded-xl bg-slate-800/80 border border-slate-700 px-3 py-2">
                <div class="text-slate-400 uppercase tracking-wide mb-1" data-i18n="context_chip">Contexto</div>
                <div id="context-display" class="text-sm font-semibold">—</div>
                <div class="text-[11px] text-slate-400 mt-1" data-i18n="context_hint">Urgência influencia ARISCAT</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Airway: Mallampati + El-Ganzouri -->
        <div class="bg-slate-900/70 border border-slate-700 rounded-2xl shadow-lg shadow-black/40">
          <div class="px-4 sm:px-5 py-4">
            <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_airway_title">Via Aérea</h2>
            <p class="text-xs text-slate-400 mt-0.5" data-i18n="section_airway_hint">Mallampati e Índice de El-Ganzouri (EGRI)</p>

            <div class="mt-3 grid gap-3 sm:grid-cols-2">
              <!-- Mallampati -->
              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="mallampati_label">Mallampati</span>
                <select id="mallampati"
                        class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950">
                  <option value="" data-i18n="select">Selecionar…</option>
                  <option value="1">I</option>
                  <option value="2">II</option>
                  <option value="3">III</option>
                  <option value="4">IV</option>
                </select>
              </label>

              <!-- Mouth opening -->
              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="mouth_opening_label">Abertura bucal (cm)</span>
                <input id="mouth-opening" type="number" step="0.1" min="0" max="10"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="4,5" data-i18n-placeholder="mouth_opening_ph" />
              </label>

              <!-- Thyromental -->
              <label class="flex flex-col text-sm">
                <span class="mb-1 text-slate-200" data-i18n="tmd_label">Distância tireomentoniana (cm)</span>
                <input id="tmd" type="number" step="0.1" min="0" max="15"
                       class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                       placeholder="7,0" data-i18n-placeholder="tmd_ph" />
              </label>

              <!-- Jaw protrusion -->
              <label class="inline-flex items-center gap-2 text-sm mt-1 sm:mt-6">
                <input id="jaw-limited" type="checkbox"
                       class="h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span class="text-slate-200" data-i18n="jaw_limited_label">Não consegue protruir a mandíbula</span>
              </label>

              <!-- Neck mobility slider -->
              <div class="sm:col-span-2 rounded-xl border border-slate-700 bg-slate-900/40 p-3">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-sm text-slate-200 font-medium" data-i18n="neck_mobility_title">Mobilidade cervical</div>
                  <div class="text-xs text-slate-300">
                    <span data-i18n="points_label">Pontos:</span>
                    <span id="neck-mobility-points" class="font-semibold">0</span>
                  </div>
                </div>
                <div class="mt-2">
                  <input id="neck-mobility" type="range" min="0" max="2" step="1"
                         class="accent-blue-500" />
                </div>
                <div class="mt-2 text-xs text-slate-300">
                  <span id="neck-mobility-label">—</span>
                </div>
              </div>

              <!-- Difficult intubation history slider -->
              <div class="sm:col-span-2 rounded-xl border border-slate-700 bg-slate-900/40 p-3">
                <div class="flex items-center justify-between gap-3">
                  <div class="text-sm text-slate-200 font-medium" data-i18n="diff_history_title">História de intubação difícil</div>
                  <div class="text-xs text-slate-300">
                    <span data-i18n="points_label">Pontos:</span>
                    <span id="diff-history-points" class="font-semibold">0</span>
                  </div>
                </div>
                <div class="mt-2">
                  <input id="diff-history" type="range" min="0" max="2" step="1"
                         class="accent-blue-500" />
                </div>
                <div class="mt-2 text-xs text-slate-300">
                  <span id="diff-history-label">—</span>
                </div>
              </div>
            </div>

            <div class="mt-4 grid gap-3 sm:grid-cols-3 text-xs">
              <div class="rounded-xl bg-slate-800/80 border border-slate-700 px-3 py-2">
                <div class="text-slate-400 uppercase tracking-wide mb-1" data-i18n="egri_chip">El-Ganzouri (EGRI)</div>
                <div class="text-sm font-semibold">
                  <span id="egri-score">0</span>
                </div>
                <div class="text-[11px] text-slate-400 mt-1">
                  <span data-i18n="category_label">Categoria:</span>
                  <span id="egri-category" class="font-semibold">—</span>
                </div>
              </div>

              <div class="rounded-xl bg-slate-800/80 border border-slate-700 px-3 py-2 sm:col-span-2">
                <div class="text-slate-400 uppercase tracking-wide mb-1" data-i18n="egri_hint_title">Regra usada</div>
                <div class="text-[11px] text-slate-300/90" data-i18n="egri_hint_text">
                  Peso: &lt;90=0; 90–110=1; &gt;110=2. Mobilidade cervical e história de intubação difícil: 0/1/2 pontos via slider.
                  Mallampati: I=0, II=1, III=2, IV=2. Risco alto se EGRI ≥ 4.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- STOP-BANG -->
        <div class="bg-slate-900/70 border border-slate-700 rounded-2xl shadow-lg shadow-black/40">
          <div class="px-4 sm:px-5 py-4">
            <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_stopbang_title">STOP-BANG (risco de AOS)</h2>
            <p class="text-xs text-slate-400 mt-0.5" data-i18n="section_stopbang_hint">Apenas rastreio (não diagnóstico)</p>

            <div class="mt-3 grid gap-2 sm:grid-cols-2 text-sm">
              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-snoring"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span data-i18n="sb_snoring">Ronco alto.</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-tired"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span data-i18n="sb_tired">Sonolência/fadiga diurna.</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-observed"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span data-i18n="sb_observed">Apneia/engasgos observados.</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-pressure"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span data-i18n="sb_pressure">Hipertensão.</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-bmi"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800"
                       disabled />
                <span data-i18n="sb_bmi">IMC &gt; 35 kg/m² (auto).</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-age"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800"
                       disabled />
                <span data-i18n="sb_age">Idade &gt; 50 anos (auto).</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-neck"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                <span data-i18n="sb_neck">Circunferência do pescoço &gt; 40 cm.</span>
              </label>

              <label class="inline-flex items-start gap-2">
                <input type="checkbox" id="sb-gender"
                       class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800"
                       disabled />
                <span data-i18n="sb_gender">Sexo masculino (auto).</span>
              </label>
            </div>

            <div class="mt-4 flex flex-wrap items-center gap-3 text-xs">
              <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                <span data-i18n="score_label">Escore:</span>
                <span id="sb-score" class="font-semibold">0</span> / 8
              </div>
              <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                <span data-i18n="category_label">Categoria:</span>
                <span id="sb-category" class="font-semibold">—</span>
              </div>
              <div class="text-slate-400" data-i18n="sb_footer">
                Escore alto sugere maior risco de AOS; interpretar clinicamente.
              </div>
            </div>
          </div>
        </div>

        <!-- Risk Scores: RCRI + ARISCAT + Apfel -->
        <div class="bg-slate-900/70 border border-slate-700 rounded-2xl shadow-lg shadow-black/40">
          <div class="px-4 sm:px-5 py-4 space-y-4">
            <div>
              <h2 class="text-base sm:text-lg font-semibold" data-i18n="section_risk_title">Escores de Risco</h2>
              <p class="text-xs text-slate-400 mt-0.5" data-i18n="section_risk_hint">RCRI, ARISCAT e Apfel (NVPO)</p>
            </div>

            <!-- RCRI -->
            <div>
              <h3 class="text-sm font-semibold mb-2">RCRI</h3>
              <div class="grid gap-2 sm:grid-cols-2 text-sm">
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="rcri-highrisk"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="rcri_highrisk">Cirurgia de alto risco (intraperitoneal, intratorácica, vascular suprainguinal).</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="rcri-ihd"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="rcri_ihd">Doença arterial coronariana/isquêmica.</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="rcri-chf"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="rcri_chf">Insuficiência cardíaca congestiva.</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="rcri-cva"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="rcri_cva">Doença cerebrovascular.</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="rcri-insulin"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="rcri_insulin">Diabetes em uso de insulina.</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="rcri-creatinine"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="rcri_creat">Creatinina &gt; 2,0 mg/dL.</span>
                </label>
              </div>

              <div class="mt-3 flex flex-wrap items-center gap-3 text-xs">
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="score_label">Escore:</span>
                  <span id="rcri-score" class="font-semibold">0</span> / 6
                </div>
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="category_label">Categoria:</span>
                  <span id="rcri-category" class="font-semibold">—</span>
                </div>
              </div>
            </div>

            <hr class="border-slate-700/70" />

            <!-- ARISCAT -->
            <div>
              <h3 class="text-sm font-semibold mb-2">ARISCAT</h3>
              <div class="grid gap-3 sm:grid-cols-2 text-sm">
                <label class="flex flex-col">
                  <span class="mb-1 text-slate-200" data-i18n="spo2_label">SpO₂ pré-op em ar ambiente (%)</span>
                  <input id="ariscat-spo2" type="number" min="70" max="100"
                         class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950"
                         placeholder="98" data-i18n-placeholder="spo2_ph" />
                </label>

                <label class="inline-flex items-center gap-2 mt-1 sm:mt-6">
                  <input type="checkbox" id="ariscat-infection"
                         class="h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="ariscat_infection">Infecção respiratória no último mês</span>
                </label>

                <label class="inline-flex items-center gap-2">
                  <input type="checkbox" id="ariscat-anemia"
                         class="h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="ariscat_anemia">Hb ≤ 10 g/dL</span>
                </label>

                <label class="flex flex-col">
                  <span class="mb-1 text-slate-200" data-i18n="incision_label">Sítio da incisão</span>
                  <select id="ariscat-incision"
                          class="rounded-lg border border-slate-600 bg-slate-800 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950">
                    <option value="" data-i18n="select">Selecionar…</option>
                    <option value="peripheral" data-i18n="inc_peripheral">Periférica</option>
                    <option value="upper-abdominal" data-i18n="inc_upper">Abdominal superior</option>
                    <option value="intrathoracic" data-i18n="inc_thoracic">Intratorácica</option>
                  </select>
                </label>
              </div>

              <div class="mt-3 flex flex-wrap items-center gap-3 text-xs">
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="score_label">Escore:</span>
                  <span id="ariscat-score" class="font-semibold">0</span>
                </div>
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="category_label">Categoria:</span>
                  <span id="ariscat-category" class="font-semibold">—</span>
                </div>
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="estimated_risk_label">Risco estimado:</span>
                  <span id="ariscat-risk" class="font-semibold">—</span>
                </div>
              </div>
            </div>

            <hr class="border-slate-700/70" />

            <!-- Apfel -->
            <div>
              <h3 class="text-sm font-semibold mb-2" data-i18n="apfel_title">Escore de Apfel (NVPO)</h3>
              <div class="grid gap-2 sm:grid-cols-2 text-sm">
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="apfel-nonsmoker"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="apfel_nonsmoker">Não fumante</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="apfel-history"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="apfel_history">História de NVPO ou cinetose</span>
                </label>
                <label class="inline-flex items-start gap-2">
                  <input type="checkbox" id="apfel-opioids"
                         class="mt-1 h-4 w-4 rounded border-slate-500 bg-slate-800 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950" />
                  <span data-i18n="apfel_opioids">Planeja opioide no pós-operatório</span>
                </label>
                <div class="text-xs text-slate-400 sm:mt-1" data-i18n="apfel_sex_auto">
                  Sexo feminino é contado automaticamente a partir da demografia.
                </div>
              </div>

              <div class="mt-3 flex flex-wrap items-center gap-3 text-xs">
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="score_label">Escore:</span>
                  <span id="apfel-score" class="font-semibold">0</span> / 4
                </div>
                <div class="rounded-full bg-slate-800/80 border border-slate-700 px-3 py-1">
                  <span data-i18n="estimated_risk_label">Risco estimado:</span>
                  <span id="apfel-risk" class="font-semibold">—</span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- RIGHT: Output -->
      <section class="space-y-4">
        <div class="bg-slate-900/70 border border-slate-700 rounded-2xl p-4 sm:p-5 shadow-lg shadow-black/40">
          <div class="flex items-start justify-between gap-3 mb-3">
            <div class="min-w-0">
              <h2 class="text-base sm:text-lg font-semibold" data-i18n="output_title">Resumo Pré-Operatório (pronto para copiar)</h2>
              <p class="text-xs text-slate-300 mt-1" data-i18n="output_hint">
                Narrativa e escores gerados automaticamente. Revise antes do uso clínico.
              </p>
            </div>
            <button id="copy-output-btn"
                    class="text-xs inline-flex items-center gap-1 rounded-full bg-slate-800 border border-slate-600 px-3 py-1
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950 shrink-0">
              <span data-i18n="copy">Copiar</span>
            </button>
          </div>

          <textarea id="output"
                    rows="18"
                    class="w-full rounded-xl border border-slate-700 bg-slate-950/60 px-3 py-2 text-xs sm:text-sm font-mono leading-relaxed
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-slate-950 resize-y"
                    spellcheck="false"></textarea>

          <div class="mt-3 text-[10px] leading-snug text-slate-400" data-i18n="disclaimer">
            Esta ferramenta não substitui julgamento clínico, protocolos institucionais ou diretrizes. Escores são aproximações e devem ser verificados.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // -------------------------
    // i18n
    // -------------------------
    const I18N = {
      en: {
        app_subtitle: "Local, browser-based tool to structure perioperative risk assessment and generate a copy-ready summary. No data is sent to a server.",
        github_link: "View on GitHub",
        validation_title: "Please review the following:",
        select: "Select…",
        male: "Male",
        female: "Female",

        section_patient_title: "Patient & Surgical Data",
        section_patient_hint: "Core demographics and procedure context",
        age_label: "Age (years)",
        age_ph: "52",
        sex_label: "Sex at birth",
        height_label: "Height (cm)",
        height_ph: "170",
        weight_label: "Weight (kg)",
        weight_ph: "120",
        asa_label: "ASA classification",
        anesthesia_label: "Planned anesthesia",
        an_general: "General anesthesia",
        an_neuraxial: "Neuraxial anesthesia",
        an_regional: "Peripheral regional anesthesia",
        an_sedation: "Sedation / monitored care",
        procedure_label: "Planned procedure (free text)",
        procedure_ph: "Laparoscopic gastric bypass",
        duration_label: "Estimated duration (hours)",
        duration_ph: "3",
        emergency_label: "Emergency surgery",

        bmi_chip: "BMI",
        bmi_hint: "Enter height & weight",
        ibw_chip: "IBW (Devine)",
        ibw_hint: "Requires sex + height",
        context_chip: "Context",
        context_hint: "Emergency flag affects ARISCAT",

        section_airway_title: "Airway",
        section_airway_hint: "Mallampati and El-Ganzouri Risk Index (EGRI)",
        mallampati_label: "Mallampati",
        mouth_opening_label: "Mouth opening (cm)",
        mouth_opening_ph: "4.5",
        tmd_label: "Thyromental distance (cm)",
        tmd_ph: "7.0",
        jaw_limited_label: "Unable to protrude mandible",

        neck_mobility_title: "Neck mobility",
        diff_history_title: "History of difficult intubation",
        points_label: "Points:",

        egri_chip: "El-Ganzouri (EGRI)",
        category_label: "Category:",
        egri_hint_title: "Rule used",
        egri_hint_text: "Weight: <90=0; 90–110=1; >110=2. Neck mobility and difficult intubation history: 0/1/2 points via slider. Mallampati: I=0, II=1, III=2, IV=2. High risk if EGRI ≥ 4.",
        score_label: "Score:",

        section_stopbang_title: "STOP-BANG (OSA risk)",
        section_stopbang_hint: "Screening only (not diagnostic)",
        sb_snoring: "Loud snoring.",
        sb_tired: "Daytime tiredness/fatigue.",
        sb_observed: "Observed apnea/gasping.",
        sb_pressure: "Hypertension.",
        sb_bmi: "BMI > 35 kg/m² (auto).",
        sb_age: "Age > 50 years (auto).",
        sb_neck: "Neck circumference > 40 cm.",
        sb_gender: "Male sex (auto).",
        sb_footer: "Higher scores suggest increased OSA risk; interpret clinically.",

        section_risk_title: "Risk Scores",
        section_risk_hint: "RCRI, ARISCAT, and Apfel (PONV)",
        rcri_highrisk: "High-risk surgery (intraperitoneal, intrathoracic, suprainguinal vascular).",
        rcri_ihd: "Ischemic heart disease.",
        rcri_chf: "Congestive heart failure.",
        rcri_cva: "Cerebrovascular disease.",
        rcri_insulin: "Diabetes on insulin.",
        rcri_creat: "Creatinine > 2.0 mg/dL.",

        spo2_label: "Pre-op SpO₂ on room air (%)",
        spo2_ph: "98",
        ariscat_infection: "Respiratory infection in last month",
        ariscat_anemia: "Hb ≤ 10 g/dL",
        incision_label: "Surgical incision site",
        inc_peripheral: "Peripheral",
        inc_upper: "Upper abdominal",
        inc_thoracic: "Intrathoracic",
        estimated_risk_label: "Estimated risk:",

        apfel_title: "Apfel score (PONV)",
        apfel_nonsmoker: "Non-smoker",
        apfel_history: "History of PONV or motion sickness",
        apfel_opioids: "Postoperative opioids planned",
        apfel_sex_auto: "Female sex is counted automatically from demographics.",

        output_title: "Preoperative Summary (copy-ready)",
        output_hint: "Auto-generated narrative and key scores. Please review before clinical use.",
        copy: "Copy",
        copied: "Copied!",

        disclaimer: "This tool does not replace clinical judgment, institutional protocols, or guidelines. Scores are approximations and must be verified.",

        // Slider labels
        neck0: "Normal (>90°)",
        neck1: "Mild limitation (80–90°)",
        neck2: "Severe limitation (<80°)",
        hist0: "No history",
        hist1: "Questionable history",
        hist2: "Definite history",

        // Output phrases
        elective: "Elective surgery.",
        emergency: "Emergency surgery.",
        asa_unspecified: "ASA physical status not specified.",
        duration_unspecified: "Estimated surgical duration not specified.",
        anesthesia_unspecified: "anesthesia technique to be defined",
        scheduled_for: "scheduled for",
        under: "under",

        patient_intro_male: "This is a {age}-year-old male patient {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_female: "This is a {age}-year-old female patient {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_neutral: "This is a patient {scheduled_for} {procedure} {under} {anesthesia}.",

        bmi_line: "BMI {bmi} kg/m² ({bmiClass}).",
        bmi_missing: "BMI not available (missing weight or height).",
        ibw_line: "IBW (Devine) {ibw} kg.",
        ibw_missing: "IBW not available (requires sex + height).",
        asa_line: "ASA physical status {asa}.",
        duration_line: "Estimated surgical duration: {dur} h.",

        sb_line: "STOP-BANG: {score}/8 ({cat}).",
        rcri_line: "RCRI: {score}/6 ({cat}).",
        ariscat_line: "ARISCAT: {score} ({cat}) — risk {risk}.",
        apfel_line: "Apfel (PONV): {score}/4 — estimated risk ~{risk}.",
        egri_line: "El-Ganzouri (difficult intubation): {score} ({cat}).",

        vent_line: "If general anesthesia: consider lung-protective ventilation with tidal volume ≈ {vt} mL (≈ 7 mL/kg IBW).",
        extras_title: "Additional considerations:",
        ponv_extra: "High PONV risk: consider multimodal prophylaxis.",
        osa_extra: "High STOP-BANG: consider intensified postoperative respiratory monitoring.",
        egri_extra: "EGRI high: plan airway strategy (video laryngoscope, team, rescue plan).",
        obesity_extra: "Severe obesity: consider higher risk of difficult airway, hypoxemia, and atelectasis.",

        // RCRI categories
        rcri0: "Low (0)",
        rcri1: "Intermediate (1)",
        rcri2: "Elevated (2)",
        rcri3: "High (≥3)",

        // STOPBANG categories
        sb_low: "Low",
        sb_int: "Intermediate",
        sb_high: "High",

        // EGRI categories
        egri_low: "Low risk",
        egri_high: "High risk",

        // ARISCAT categories
        ar_low: "Low",
        ar_int: "Intermediate",
        ar_high: "High"
      },

      pt: {
        app_subtitle: "Ferramenta local (no navegador) para estruturar avaliação perioperatória e gerar um resumo pronto para copiar. Nenhum dado é enviado para servidor.",
        github_link: "Ver no GitHub",
        validation_title: "Revise os itens abaixo:",
        select: "Selecionar…",
        male: "Masculino",
        female: "Feminino",

        section_patient_title: "Dados do Paciente e Cirurgia",
        section_patient_hint: "Demografia e contexto do procedimento",
        age_label: "Idade (anos)",
        age_ph: "52",
        sex_label: "Sexo ao nascimento",
        height_label: "Altura (cm)",
        height_ph: "170",
        weight_label: "Peso (kg)",
        weight_ph: "120",
        asa_label: "Classificação ASA",
        anesthesia_label: "Anestesia planejada",
        an_general: "Anestesia geral",
        an_neuraxial: "Anestesia neuroaxial",
        an_regional: "Anestesia regional periférica",
        an_sedation: "Sedação / cuidado monitorizado",
        procedure_label: "Procedimento planejado (texto livre)",
        procedure_ph: "Bypass gástrico laparoscópico",
        duration_label: "Duração estimada (horas)",
        duration_ph: "3",
        emergency_label: "Cirurgia de urgência/emergência",

        bmi_chip: "IMC",
        bmi_hint: "Informe altura e peso",
        ibw_chip: "Peso ideal (Devine)",
        ibw_hint: "Requer sexo + altura",
        context_chip: "Contexto",
        context_hint: "Urgência influencia ARISCAT",

        section_airway_title: "Via Aérea",
        section_airway_hint: "Mallampati e Índice de El-Ganzouri (EGRI)",
        mallampati_label: "Mallampati",
        mouth_opening_label: "Abertura bucal (cm)",
        mouth_opening_ph: "4,5",
        tmd_label: "Distância tireomentoniana (cm)",
        tmd_ph: "7,0",
        jaw_limited_label: "Não consegue protruir a mandíbula",

        neck_mobility_title: "Mobilidade cervical",
        diff_history_title: "História de intubação difícil",
        points_label: "Pontos:",

        egri_chip: "El-Ganzouri (EGRI)",
        category_label: "Categoria:",
        egri_hint_title: "Regra usada",
        egri_hint_text: "Peso: <90=0; 90–110=1; >110=2. Mobilidade cervical e história de intubação difícil: 0/1/2 pontos via slider. Mallampati: I=0, II=1, III=2, IV=2. Risco alto se EGRI ≥ 4.",
        score_label: "Escore:",

        section_stopbang_title: "STOP-BANG (risco de AOS)",
        section_stopbang_hint: "Apenas rastreio (não diagnóstico)",
        sb_snoring: "Ronco alto.",
        sb_tired: "Sonolência/fadiga diurna.",
        sb_observed: "Apneia/engasgos observados.",
        sb_pressure: "Hipertensão.",
        sb_bmi: "IMC > 35 kg/m² (auto).",
        sb_age: "Idade > 50 anos (auto).",
        sb_neck: "Circunferência do pescoço > 40 cm.",
        sb_gender: "Sexo masculino (auto).",
        sb_footer: "Escore alto sugere maior risco de AOS; interpretar clinicamente.",

        section_risk_title: "Escores de Risco",
        section_risk_hint: "RCRI, ARISCAT e Apfel (NVPO)",
        rcri_highrisk: "Cirurgia de alto risco (intraperitoneal, intratorácica, vascular suprainguinal).",
        rcri_ihd: "Doença arterial coronariana/isquêmica.",
        rcri_chf: "Insuficiência cardíaca congestiva.",
        rcri_cva: "Doença cerebrovascular.",
        rcri_insulin: "Diabetes em uso de insulina.",
        rcri_creat: "Creatinina > 2,0 mg/dL.",

        spo2_label: "SpO₂ pré-op em ar ambiente (%)",
        spo2_ph: "98",
        ariscat_infection: "Infecção respiratória no último mês",
        ariscat_anemia: "Hb ≤ 10 g/dL",
        incision_label: "Sítio da incisão",
        inc_peripheral: "Periférica",
        inc_upper: "Abdominal superior",
        inc_thoracic: "Intratorácica",
        estimated_risk_label: "Risco estimado:",

        apfel_title: "Escore de Apfel (NVPO)",
        apfel_nonsmoker: "Não fumante",
        apfel_history: "História de NVPO ou cinetose",
        apfel_opioids: "Planeja opioide no pós-operatório",
        apfel_sex_auto: "Sexo feminino é contado automaticamente a partir da demografia.",

        output_title: "Resumo Pré-Operatório (pronto para copiar)",
        output_hint: "Narrativa e escores gerados automaticamente. Revise antes do uso clínico.",
        copy: "Copiar",
        copied: "Copiado!",

        disclaimer: "Esta ferramenta não substitui julgamento clínico, protocolos institucionais ou diretrizes. Escores são aproximações e devem ser verificados.",

        // Slider labels
        neck0: "Normal (>90°)",
        neck1: "Limitação leve (80–90°)",
        neck2: "Limitação grave (<80°)",
        hist0: "Sem história",
        hist1: "História duvidosa",
        hist2: "História definitiva",

        // Output phrases
        elective: "Cirurgia eletiva.",
        emergency: "Cirurgia de urgência/emergência.",
        asa_unspecified: "Estado físico ASA não informado.",
        duration_unspecified: "Duração estimada não informada.",
        anesthesia_unspecified: "técnica anestésica a definir",
        scheduled_for: "agendado(a) para",
        under: "sob",

        patient_intro_male: "Paciente masculino de {age} anos {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_female: "Paciente feminino de {age} anos {scheduled_for} {procedure} {under} {anesthesia}.",
        patient_intro_neutral: "Paciente {scheduled_for} {procedure} {under} {anesthesia}.",

        bmi_line: "IMC {bmi} kg/m² ({bmiClass}).",
        bmi_missing: "IMC indisponível (faltam altura e/ou peso).",
        ibw_line: "Peso ideal (Devine) {ibw} kg.",
        ibw_missing: "Peso ideal indisponível (requer sexo + altura).",
        asa_line: "Estado físico ASA {asa}.",
        duration_line: "Duração estimada: {dur} h.",

        sb_line: "STOP-BANG: {score}/8 ({cat}).",
        rcri_line: "RCRI: {score}/6 ({cat}).",
        ariscat_line: "ARISCAT: {score} ({cat}) — risco {risk}.",
        apfel_line: "Apfel (NVPO): {score}/4 — risco estimado ~{risk}.",
        egri_line: "El-Ganzouri (intubação difícil): {score} ({cat}).",

        vent_line: "Se anestesia geral: considerar ventilação protetora com volume corrente ≈ {vt} mL (≈ 7 mL/kg do peso ideal).",
        extras_title: "Pontos adicionais:",
        ponv_extra: "Risco elevado de NVPO: considerar profilaxia multimodal.",
        osa_extra: "STOP-BANG alto: considerar monitorização respiratória pós-op intensificada.",
        egri_extra: "EGRI alto: planejar estratégia de via aérea (videolaringoscópio, equipe, plano de resgate).",
        obesity_extra: "Obesidade grave: considerar maior risco de via aérea difícil, hipóxia e atelectasia.",

        // RCRI categories
        rcri0: "Baixo (0)",
        rcri1: "Intermediário (1)",
        rcri2: "Elevado (2)",
        rcri3: "Alto (≥3)",

        // STOPBANG categories
        sb_low: "Baixo",
        sb_int: "Intermediário",
        sb_high: "Alto",

        // EGRI categories
        egri_low: "Baixo risco",
        egri_high: "Alto risco",

        // ARISCAT categories
        ar_low: "Baixo",
        ar_int: "Intermediário",
        ar_high: "Alto"
      }
    };

    // Default: Portuguese
    const state = { lang: "pt" };

    function t(key) {
      return (I18N[state.lang] && I18N[state.lang][key]) ?? I18N.en[key] ?? key;
    }

    function applyI18n() {
      document.querySelectorAll("[data-i18n]").forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = t(key);
      });
      document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
        const key = el.getAttribute("data-i18n-placeholder");
        el.setAttribute("placeholder", t(key));
      });
      document.querySelectorAll("option[data-i18n]").forEach(opt => {
        const key = opt.getAttribute("data-i18n");
        opt.textContent = t(key);
      });
    }

    // -------------------------
    // Helpers
    // -------------------------
    function toNumber(value) {
      const n = parseFloat(String(value).replace(",", "."));
      return Number.isFinite(n) ? n : null;
    }
    function fmt1(n) { return (Math.round(n * 10) / 10).toFixed(1); }
    function clamp(num, min, max) { return Math.min(Math.max(num, min), max); }
    function template(str, vars) {
      return str.replace(/\{(\w+)\}/g, (_, k) => (vars[k] ?? ""));
    }

    function classifyBMI(bmi) {
      if (bmi == null) return { label: "—" };
      if (bmi < 18.5) return { label: state.lang === "pt" ? "Baixo peso" : "Underweight" };
      if (bmi < 25) return { label: state.lang === "pt" ? "Normal" : "Normal" };
      if (bmi < 30) return { label: state.lang === "pt" ? "Sobrepeso" : "Overweight" };
      if (bmi < 35) return { label: state.lang === "pt" ? "Obesidade I" : "Obesity I" };
      if (bmi < 40) return { label: state.lang === "pt" ? "Obesidade II" : "Obesity II" };
      return { label: state.lang === "pt" ? "Obesidade III" : "Obesity III" };
    }

    function classifyStopBang(score) {
      if (score <= 2) return t("sb_low");
      if (score <= 4) return t("sb_int");
      return t("sb_high");
    }

    function classifyRCRI(score) {
      if (score === 0) return t("rcri0");
      if (score === 1) return t("rcri1");
      if (score === 2) return t("rcri2");
      return t("rcri3");
    }

    // Devine IBW (kg)
    function devineIBW(sex, heightCm) {
      if (!sex || heightCm == null) return null;
      const inches = heightCm / 2.54;
      const base = sex === "male" ? 50 : 45.5;
      const ibw = base + 2.3 * (inches - 60);
      return Math.round(ibw * 10) / 10;
    }

    // Apfel mapping
    function apfelRiskPercent(score) {
      const map = { 0: "10%", 1: "21%", 2: "39%", 3: "61%", 4: "79%" };
      return map[clamp(score, 0, 4)] ?? "—";
    }

    // ARISCAT (as specified)
    function computeARISCAT(age, spo2, infection, anemia, incision, durationHours, emergency) {
      let score = 0;

      // Age: ≤50=0; 51–80=3; 81+=16
      if (age != null) {
        if (age >= 51 && age <= 80) score += 3;
        else if (age >= 81) score += 16;
      }

      // SpO2: ≥96=0; 91–95=8; ≤90=24
      if (spo2 != null) {
        if (spo2 >= 96) score += 0;
        else if (spo2 >= 91 && spo2 <= 95) score += 8;
        else score += 24;
      }

      if (infection) score += 17;
      if (anemia) score += 11;

      // incision: peripheral=0; upper abdominal=15; intrathoracic=24
      if (incision === "upper-abdominal") score += 15;
      else if (incision === "intrathoracic") score += 24;

      // duration: <2=0; 2–3=16; >3=23
      if (durationHours != null) {
        if (durationHours < 2) score += 0;
        else if (durationHours <= 3) score += 16;
        else score += 23;
      }

      // emergency +8
      if (emergency) score += 8;

      // categories + risks:
      // <26 low 1.6%; 26-44 intermediate 13.3%; ≥45 high 42.1%
      let categoryKey, riskText;
      if (score < 26) {
        categoryKey = "ar_low";
        riskText = "1.6%";
      } else if (score <= 44) {
        categoryKey = "ar_int";
        riskText = "13.3%";
      } else {
        categoryKey = "ar_high";
        riskText = "42.1%";
      }

      return { score, category: t(categoryKey), risk: riskText };
    }

    // El-Ganzouri Risk Index (EGRI) with your exact rules
    function computeEGRI({ mallampati, mouthOpening, tmd, jawLimited, weightKg, neckMobilityPoints, diffHistoryPoints }) {
      let score = 0;

      // Weight: <90=0; 90–110=1; >110=2
      if (weightKg != null) {
        if (weightKg >= 90 && weightKg <= 110) score += 1;
        else if (weightKg > 110) score += 2;
      }

      // Neck mobility: 0/1/2 via slider
      score += (neckMobilityPoints ?? 0);

      // Mouth opening <4 cm: +1
      if (mouthOpening != null && mouthOpening < 4) score += 1;

      // Jaw protrusion limited: +1
      if (jawLimited) score += 1;

      // Thyromental distance <6.5 cm: +1
      if (tmd != null && tmd < 6.5) score += 1;

      // Mallampati: I=0; II=1; III=2; IV=2
      if (mallampati === 2) score += 1;
      else if (mallampati === 3) score += 2;
      else if (mallampati === 4) score += 2;

      // History of difficult intubation: 0/1/2 via slider
      score += (diffHistoryPoints ?? 0);

      // High risk if ≥4 else low
      const cat = (score >= 4) ? t("egri_high") : t("egri_low");
      return { score, category: cat };
    }

    // -------------------------
    // DOM refs
    // -------------------------
    const ageEl = document.getElementById("age");
    const sexEl = document.getElementById("sex");
    const heightEl = document.getElementById("height");
    const weightEl = document.getElementById("weight");
    const asaEl = document.getElementById("asa");
    const anesthesiaTypeEl = document.getElementById("anesthesia-type");
    const procedureEl = document.getElementById("procedure");
    const durationEl = document.getElementById("surgery-duration");
    const emergencyEl = document.getElementById("emergency-surgery");

    const bmiDisplayEl = document.getElementById("bmi-display");
    const bmiCategoryEl = document.getElementById("bmi-category");
    const ibwDisplayEl = document.getElementById("ibw-display");
    const contextDisplayEl = document.getElementById("context-display");

    const mallampatiEl = document.getElementById("mallampati");
    const mouthOpeningEl = document.getElementById("mouth-opening");
    const tmdEl = document.getElementById("tmd");
    const jawLimitedEl = document.getElementById("jaw-limited");

    const neckMobilityEl = document.getElementById("neck-mobility");
    const neckMobilityPointsEl = document.getElementById("neck-mobility-points");
    const neckMobilityLabelEl = document.getElementById("neck-mobility-label");

    const diffHistoryEl = document.getElementById("diff-history");
    const diffHistoryPointsEl = document.getElementById("diff-history-points");
    const diffHistoryLabelEl = document.getElementById("diff-history-label");

    const egriScoreEl = document.getElementById("egri-score");
    const egriCategoryEl = document.getElementById("egri-category");

    const sbSnoringEl = document.getElementById("sb-snoring");
    const sbTiredEl = document.getElementById("sb-tired");
    const sbObservedEl = document.getElementById("sb-observed");
    const sbPressureEl = document.getElementById("sb-pressure");
    const sbBmiEl = document.getElementById("sb-bmi");
    const sbAgeEl = document.getElementById("sb-age");
    const sbNeckEl = document.getElementById("sb-neck");
    const sbGenderEl = document.getElementById("sb-gender");
    const sbScoreEl = document.getElementById("sb-score");
    const sbCategoryEl = document.getElementById("sb-category");

    const rcriHighRiskEl = document.getElementById("rcri-highrisk");
    const rcriIhdEl = document.getElementById("rcri-ihd");
    const rcriChfEl = document.getElementById("rcri-chf");
    const rcriCvaEl = document.getElementById("rcri-cva");
    const rcriInsulinEl = document.getElementById("rcri-insulin");
    const rcriCreatEl = document.getElementById("rcri-creatinine");
    const rcriScoreEl = document.getElementById("rcri-score");
    const rcriCategoryEl = document.getElementById("rcri-category");

    const ariscatSpo2El = document.getElementById("ariscat-spo2");
    const ariscatInfectionEl = document.getElementById("ariscat-infection");
    const ariscatAnemiaEl = document.getElementById("ariscat-anemia");
    const ariscatIncisionEl = document.getElementById("ariscat-incision");
    const ariscatScoreEl = document.getElementById("ariscat-score");
    const ariscatCategoryEl = document.getElementById("ariscat-category");
    const ariscatRiskEl = document.getElementById("ariscat-risk");

    const apfelNonsmokerEl = document.getElementById("apfel-nonsmoker");
    const apfelHistoryEl = document.getElementById("apfel-history");
    const apfelOpioidsEl = document.getElementById("apfel-opioids");
    const apfelScoreEl = document.getElementById("apfel-score");
    const apfelRiskEl = document.getElementById("apfel-risk");

    const outputEl = document.getElementById("output");
    const copyBtn = document.getElementById("copy-output-btn");

    const bannerEl = document.getElementById("validation-banner");
    const vListEl = document.getElementById("validation-list");

    const langEnBtn = document.getElementById("lang-en-btn");
    const langPtBtn = document.getElementById("lang-pt-btn");

    // -------------------------
    // Validation
    // -------------------------
    function validateInputs({ age, height, weight, spo2, duration, mouthOpening, tmd }) {
      const issues = [];
      if (age != null && (age < 16 || age > 100)) issues.push(state.lang === "pt" ? "Idade fora do intervalo (16–100)." : "Age out of range (16–100).");
      if (height != null && (height < 120 || height > 220)) issues.push(state.lang === "pt" ? "Altura fora do intervalo (120–220 cm)." : "Height out of range (120–220 cm).");
      if (weight != null && (weight < 30 || weight > 300)) issues.push(state.lang === "pt" ? "Peso fora do intervalo (30–300 kg)." : "Weight out of range (30–300 kg).");
      if (spo2 != null && (spo2 < 70 || spo2 > 100)) issues.push(state.lang === "pt" ? "SpO₂ fora do intervalo (70–100%)." : "SpO₂ out of range (70–100%).");
      if (duration != null && (duration < 0 || duration > 12)) issues.push(state.lang === "pt" ? "Duração fora do intervalo (0–12 h)." : "Duration out of range (0–12 h).");
      if (mouthOpening != null && (mouthOpening < 0 || mouthOpening > 10)) issues.push(state.lang === "pt" ? "Abertura bucal fora do intervalo (0–10 cm)." : "Mouth opening out of range (0–10 cm).");
      if (tmd != null && (tmd < 0 || tmd > 15)) issues.push(state.lang === "pt" ? "Distância tireomentoniana fora do intervalo (0–15 cm)." : "Thyromental distance out of range (0–15 cm).");
      if (height != null && height > 200 && weight != null && weight < 40) {
        issues.push(state.lang === "pt" ? "Possível erro: altura muito alta com peso muito baixo." : "Possible typo: very tall height with very low weight.");
      }
      return issues;
    }

    function renderValidation(issues) {
      if (!issues.length) {
        bannerEl.classList.add("hidden");
        vListEl.innerHTML = "";
        return;
      }
      vListEl.innerHTML = "";
      issues.forEach(msg => {
        const li = document.createElement("li");
        li.textContent = msg;
        vListEl.appendChild(li);
      });
      bannerEl.classList.remove("hidden");
    }

    // -------------------------
    // Slider label helpers
    // -------------------------
    function updateNeckMobilityUI(val) {
      const v = Number(val);
      neckMobilityPointsEl.textContent = String(v);
      const key = v === 0 ? "neck0" : (v === 1 ? "neck1" : "neck2");
      neckMobilityLabelEl.textContent = t(key);
    }

    function updateDiffHistoryUI(val) {
      const v = Number(val);
      diffHistoryPointsEl.textContent = String(v);
      const key = v === 0 ? "hist0" : (v === 1 ? "hist1" : "hist2");
      diffHistoryLabelEl.textContent = t(key);
    }

    // -------------------------
    // Recompute
    // -------------------------
    function recompute() {
      const age = toNumber(ageEl.value);
      const sex = sexEl.value || null;
      const height = toNumber(heightEl.value);
      const weight = toNumber(weightEl.value);
      const asa = asaEl.value || null;
      const anesthesiaType = anesthesiaTypeEl.value || null;
      const procedure = (procedureEl.value || "").trim();
      const duration = toNumber(durationEl.value);
      const emergency = emergencyEl.checked;

      const mallampati = toNumber(mallampatiEl.value);
      const mouthOpening = toNumber(mouthOpeningEl.value);
      const tmd = toNumber(tmdEl.value);
      const jawLimited = jawLimitedEl.checked;

      const neckMobilityPoints = Number(neckMobilityEl.value || 0);
      const diffHistoryPoints = Number(diffHistoryEl.value || 0);

      const spo2 = toNumber(ariscatSpo2El.value);
      const infection = ariscatInfectionEl.checked;
      const anemia = ariscatAnemiaEl.checked;
      const incision = ariscatIncisionEl.value || null;

      // Keep slider UIs in sync (especially after language switch)
      updateNeckMobilityUI(neckMobilityPoints);
      updateDiffHistoryUI(diffHistoryPoints);

      // Validation
      const issues = validateInputs({ age, height, weight, spo2, duration, mouthOpening, tmd });
      renderValidation(issues);

      // BMI
      let bmi = null;
      if (height != null && weight != null && height > 0) {
        const hm = height / 100;
        bmi = weight / (hm * hm);
      }
      if (bmi != null) bmiDisplayEl.textContent = `${fmt1(bmi)} kg/m²`;
      else bmiDisplayEl.textContent = "—";
      const bmiClass = classifyBMI(bmi);
      bmiCategoryEl.textContent = (bmi != null) ? bmiClass.label : t("bmi_hint");

      // IBW
      const ibw = devineIBW(sex, height);
      if (ibw != null && ibw > 0 && Number.isFinite(ibw)) ibwDisplayEl.textContent = `${fmt1(ibw)} kg`;
      else ibwDisplayEl.textContent = "—";

      // Context
      contextDisplayEl.textContent = emergency ? t("emergency") : t("elective");

      // STOP-BANG auto flags
      sbBmiEl.checked = (bmi != null && bmi > 35);
      sbAgeEl.checked = (age != null && age > 50);
      sbGenderEl.checked = (sex === "male");

      let sbScore = 0;
      [sbSnoringEl, sbTiredEl, sbObservedEl, sbPressureEl, sbBmiEl, sbAgeEl, sbNeckEl, sbGenderEl].forEach(el => {
        if (el.checked) sbScore += 1;
      });
      sbScoreEl.textContent = sbScore;
      const sbCat = classifyStopBang(sbScore);
      sbCategoryEl.textContent = sbCat;

      // RCRI
      let rcriScore = 0;
      [rcriHighRiskEl, rcriIhdEl, rcriChfEl, rcriCvaEl, rcriInsulinEl, rcriCreatEl].forEach(el => {
        if (el.checked) rcriScore += 1;
      });
      rcriScoreEl.textContent = rcriScore;
      const rcriCat = classifyRCRI(rcriScore);
      rcriCategoryEl.textContent = rcriCat;

      // ARISCAT (with risks)
      const ariscat = computeARISCAT(age, spo2, infection, anemia, incision, duration, emergency);
      ariscatScoreEl.textContent = ariscat.score;
      ariscatCategoryEl.textContent = ariscat.category;
      ariscatRiskEl.textContent = ariscat.risk;

      // Apfel
      const apfelFemale = (sex === "female") ? 1 : 0;
      const apfelNonSmoker = apfelNonsmokerEl.checked ? 1 : 0;
      const apfelHist = apfelHistoryEl.checked ? 1 : 0;
      const apfelOpioids = apfelOpioidsEl.checked ? 1 : 0;
      const apfelScore = apfelFemale + apfelNonSmoker + apfelHist + apfelOpioids;
      apfelScoreEl.textContent = apfelScore;
      const apfelRisk = apfelRiskPercent(apfelScore);
      apfelRiskEl.textContent = apfelRisk;

      // EGRI (El-Ganzouri)
      const egri = computeEGRI({
        mallampati: Number.isFinite(mallampati) ? mallampati : null,
        mouthOpening,
        tmd,
        jawLimited,
        weightKg: weight,
        neckMobilityPoints,
        diffHistoryPoints
      });
      egriScoreEl.textContent = egri.score;
      egriCategoryEl.textContent = egri.category;

      // Anesthesia label
      const anesthesiaLabel = (() => {
        if (!anesthesiaType) return t("anesthesia_unspecified");
        const map = {
          general: t("an_general"),
          neuraxial: t("an_neuraxial"),
          regional: t("an_regional"),
          sedation: t("an_sedation")
        };
        return map[anesthesiaType] || t("anesthesia_unspecified");
      })();

      // Intro
      const intro = (() => {
        const procText = procedure || (state.lang === "pt" ? "procedimento cirúrgico" : "surgical procedure");
        const vars = {
          age: (age != null ? age : ""),
          scheduled_for: t("scheduled_for"),
          procedure: procText,
          under: t("under"),
          anesthesia: anesthesiaLabel
        };
        if (sex === "male" && age != null) return template(t("patient_intro_male"), vars);
        if (sex === "female" && age != null) return template(t("patient_intro_female"), vars);
        return template(t("patient_intro_neutral"), vars);
      })();

      const bmiLine = (bmi != null)
        ? template(t("bmi_line"), { bmi: fmt1(bmi), bmiClass: bmiClass.label })
        : t("bmi_missing");

      const ibwLine = (ibw != null && ibw > 0)
        ? template(t("ibw_line"), { ibw: fmt1(ibw) })
        : t("ibw_missing");

      const asaLine = asa
        ? template(t("asa_line"), { asa })
        : t("asa_unspecified");

      const durationLine = (duration != null)
        ? template(t("duration_line"), { dur: fmt1(duration) })
        : t("duration_unspecified");

      const contextLine = emergency ? t("emergency") : t("elective");

      // Ventilation suggestion for GA
      let ventLine = "";
      if (anesthesiaType === "general" && ibw != null && ibw > 0) {
        const vtMl = Math.round(7 * ibw);
        ventLine = template(t("vent_line"), { vt: String(vtMl) });
      }

      // Output lines
      const sbLine = template(t("sb_line"), { score: sbScore, cat: sbCat });
      const rcriLine = template(t("rcri_line"), { score: rcriScore, cat: rcriCat });
      const ariscatLine = template(t("ariscat_line"), { score: ariscat.score, cat: ariscat.category, risk: ariscat.risk });
      const apfelLine = template(t("apfel_line"), { score: apfelScore, risk: apfelRisk });
      const egriLine = template(t("egri_line"), { score: egri.score, cat: egri.category });

      // Extras
      const extras = [];
      if (bmi != null && bmi >= 40) extras.push(t("obesity_extra"));
      if (sbScore >= 5) extras.push(t("osa_extra"));
      if (egri.score >= 4) extras.push(t("egri_extra"));
      if (apfelScore >= 3) extras.push(t("ponv_extra"));

      const extrasBlock = extras.length
        ? `${t("extras_title")}\n- ${extras.join("\n- ")}`
        : "";

      const lines = [
        intro,
        "",
        [bmiLine, ibwLine, asaLine, durationLine, contextLine].join(" "),
        "",
        egriLine,
        sbLine,
        rcriLine,
        ariscatLine,
        apfelLine,
        (ventLine ? ventLine : ""),
        "",
        (extrasBlock ? extrasBlock : "")
      ].filter(Boolean);

      outputEl.value = lines.join("\n");
    }

    // -------------------------
    // Events
    // -------------------------
    const watch = [
      ageEl, sexEl, heightEl, weightEl, asaEl, anesthesiaTypeEl, procedureEl, durationEl, emergencyEl,
      mallampatiEl, mouthOpeningEl, tmdEl, jawLimitedEl,
      neckMobilityEl, diffHistoryEl,
      sbSnoringEl, sbTiredEl, sbObservedEl, sbPressureEl, sbNeckEl,
      rcriHighRiskEl, rcriIhdEl, rcriChfEl, rcriCvaEl, rcriInsulinEl, rcriCreatEl,
      ariscatSpo2El, ariscatInfectionEl, ariscatAnemiaEl, ariscatIncisionEl,
      apfelNonsmokerEl, apfelHistoryEl, apfelOpioidsEl
    ];

    watch.forEach(el => {
      const ev = (el.type === "checkbox" || el.tagName === "SELECT" || el.type === "range") ? "change" : "input";
      el.addEventListener(ev, recompute);
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(outputEl.value);
      } catch {
        outputEl.select();
        document.execCommand("copy");
      }
      copyBtn.textContent = t("copied");
      setTimeout(() => { copyBtn.textContent = t("copy"); }, 1100);
    });

    // -------------------------
    // Language toggle
    // -------------------------
    function setLang(lang) {
      state.lang = lang;

      if (lang === "pt") {
        langPtBtn.classList.add("bg-blue-500", "text-white", "font-medium");
        langEnBtn.classList.remove("bg-blue-500", "text-white", "font-medium");
      } else {
        langEnBtn.classList.add("bg-blue-500", "text-white", "font-medium");
        langPtBtn.classList.remove("bg-blue-500", "text-white", "font-medium");
      }

      // Update page language attribute
      document.documentElement.lang = (lang === "pt") ? "pt-BR" : "en";

      applyI18n();
      // After i18n, refresh slider labels and recompute everything
      updateNeckMobilityUI(Number(neckMobilityEl.value || 0));
      updateDiffHistoryUI(Number(diffHistoryEl.value || 0));
      recompute();
    }

    langPtBtn.addEventListener("click", () => setLang("pt"));
    langEnBtn.addEventListener("click", () => setLang("en"));

    // -------------------------
    // Init
    // -------------------------
    // Default slider positions: 0
    neckMobilityEl.value = "0";
    diffHistoryEl.value = "0";

    applyI18n();
    setLang("pt");
  </script>
</body>
</html>
